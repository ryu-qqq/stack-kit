# StackKit Atlantis Integration Workflow  
# ì¤‘ì•™ Atlantisì™€ ì—°ë™í•˜ì—¬ ì¶”ê°€ì ì¸ ê²€ì¦ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

name: ğŸ¤– Atlantis Integration

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tfvars'
      - 'atlantis.yaml'
  
  issue_comment:
    types: [created]

env:
  ATLANTIS_URL: ${{ secrets.ATLANTIS_URL }}
  AWS_REGION: "ap-northeast-2"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  atlantis-notification:
    name: ğŸ”” Atlantis ì•Œë¦¼
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Atlantis ìƒíƒœ í™•ì¸
        id: atlantis-check
        run: |
          if [ -n "${{ env.ATLANTIS_URL }}" ]; then
            # Atlantis ì„œë²„ ìƒíƒœ í™•ì¸
            if curl -s --max-time 10 "${{ env.ATLANTIS_URL }}/healthz" > /dev/null; then
              echo "atlantis_available=true" >> $GITHUB_OUTPUT
              echo "âœ… Atlantis ì„œë²„ê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
            else
              echo "atlantis_available=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ Atlantis ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            fi
          else
            echo "atlantis_available=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Atlantis URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          fi

      - name: ë³€ê²½ëœ Terraform íŒŒì¼ ë¶„ì„
        id: changes
        run: |
          echo "ğŸ” ë³€ê²½ëœ Terraform íŒŒì¼ ë¶„ì„ ì¤‘..."
          
          changed_files=$(git diff --name-only origin/${{ github.base_ref }}..HEAD)
          tf_changes=$(echo "$changed_files" | grep -E '\.(tf|tfvars)$' | wc -l)
          
          echo "terraform_changes=$tf_changes" >> $GITHUB_OUTPUT
          
          if [ $tf_changes -gt 0 ]; then
            echo "ğŸ“ ë³€ê²½ëœ Terraform íŒŒì¼: $tf_changes ê°œ"
            echo "$changed_files" | grep -E '\.(tf|tfvars)$' | head -10
            
            if [ $tf_changes -gt 10 ]; then
              echo "... (ë” ë§ì€ íŒŒì¼ë“¤ì´ ë³€ê²½ë¨)"
            fi
          else
            echo "â„¹ï¸ Terraform íŒŒì¼ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi

      - name: PRì— Atlantis ì•ˆë‚´ ì½”ë©˜íŠ¸ ì¶”ê°€
        if: steps.atlantis-check.outputs.atlantis_available == 'true' && steps.changes.outputs.terraform_changes > 0
        uses: actions/github-script@v7
        with:
          script: |
            const tfChanges = ${{ steps.changes.outputs.terraform_changes }};
            const atlantisUrl = '${{ env.ATLANTIS_URL }}';
            
            const comment = `## ğŸ¤– Atlantis ìë™ ê²€ì¦ ì•ˆë‚´
            
            ì´ PRì—ëŠ” **${tfChanges}ê°œ**ì˜ Terraform íŒŒì¼ ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ğŸš€ ë‹¤ìŒ ë‹¨ê³„
            
            1. **ìë™ Plan**: Atlantisê°€ ê³§ ìë™ìœ¼ë¡œ \`terraform plan\`ì„ ì‹¤í–‰í•©ë‹ˆë‹¤
            2. **AI ë¦¬ë·°**: AI ë¦¬ë·°ì–´ê°€ Plan ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³  Slackì— ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤
            3. **ê²€í†  í›„ ì ìš©**: ë¦¬ë·° ì™„ë£Œ í›„ \`atlantis apply\`ë¡œ ì¸í”„ë¼ë¥¼ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            
            ### ğŸ’¬ Atlantis ëª…ë ¹ì–´
            
            ì´ PRì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª…ë ¹ì–´:
            - \`atlantis plan\` - ìˆ˜ë™ìœ¼ë¡œ Plan ì‹¤í–‰
            - \`atlantis apply\` - Plan ìŠ¹ì¸ í›„ Apply ì‹¤í–‰  
            - \`atlantis unlock\` - ì ê¸ˆ í•´ì œ (í•„ìš”ì‹œ)
            - \`atlantis help\` - ë„ì›€ë§ ë³´ê¸°
            
            ### ğŸ”— ìœ ìš©í•œ ë§í¬
            
            - [Atlantis ì„œë²„](${atlantisUrl})
            - [StackKit ë¬¸ì„œ](https://github.com/yourorg/stackkit#readme)
            
            ---
            *ğŸ¤– StackKit ìë™ ì•Œë¦¼ | Atlantis ì„œë²„: ${atlantisUrl}*`;
            
            // ê¸°ì¡´ Atlantis ì½”ë©˜íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ¤– Atlantis ìë™ ê²€ì¦ ì•ˆë‚´')
            );
            
            if (!existingComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('Atlantis ì•ˆë‚´ ì½”ë©˜íŠ¸ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.');
            }

  command-monitor:
    name: ğŸ¯ Atlantis ëª…ë ¹ì–´ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, 'atlantis')
    
    steps:
      - name: Atlantis ëª…ë ¹ì–´ ê°ì§€
        run: |
          comment="${{ github.event.comment.body }}"
          user="${{ github.event.comment.user.login }}"
          
          echo "ğŸ‘¤ ì‚¬ìš©ì: $user"
          echo "ğŸ’¬ ì½”ë©˜íŠ¸: $comment"
          
          if echo "$comment" | grep -q "atlantis plan"; then
            echo "ğŸ” Atlantis Plan ëª…ë ¹ì–´ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤"
          elif echo "$comment" | grep -q "atlantis apply"; then
            echo "ğŸš€ Atlantis Apply ëª…ë ¹ì–´ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤"  
          elif echo "$comment" | grep -q "atlantis unlock"; then
            echo "ğŸ”“ Atlantis Unlock ëª…ë ¹ì–´ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤"
          elif echo "$comment" | grep -q "atlantis help"; then
            echo "â“ Atlantis Help ëª…ë ¹ì–´ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi
          
          echo "â„¹ï¸ Atlantisê°€ ì´ ëª…ë ¹ì–´ë¥¼ ì²˜ë¦¬í•  ê²ƒì…ë‹ˆë‹¤"

  atlantis-status-check:
    name: ğŸ“Š Atlantis ìƒíƒœ í™•ì¸
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.action == 'synchronize'
    
    steps:
      - name: PR ì—…ë°ì´íŠ¸ì— ëŒ€í•œ Atlantis ìƒíƒœ ì•Œë¦¼
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ”„ PR ì—…ë°ì´íŠ¸ ê°ì§€
            
            ìƒˆë¡œìš´ ì»¤ë°‹ì´ í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤. Atlantisê°€ ìë™ìœ¼ë¡œ ìƒˆë¡œìš´ Planì„ ì‹¤í–‰í•  ì˜ˆì •ì…ë‹ˆë‹¤.
            
            ### ğŸ“‹ ì§„í–‰ ìƒí™©
            - âœ… ìƒˆ ì»¤ë°‹ ê°ì§€ë¨
            - â³ Atlantis Plan ëŒ€ê¸° ì¤‘...
            - ğŸ¤– AI ë¦¬ë·°ì–´ ì¤€ë¹„ ì™„ë£Œ
            
            *ì´ì „ Plan ê²°ê³¼ëŠ” ë¬´íš¨í™”ë˜ì—ˆìŠµë‹ˆë‹¤.*
            
            ---
            *ğŸ”„ ìë™ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo, 
              issue_number: context.issue.number,
              body: comment
            });

  validate-atlantis-config:
    name: ğŸ”§ atlantis.yaml ê²€ì¦
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'atlantis.yaml')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: atlantis.yaml êµ¬ë¬¸ ê²€ì¦
        run: |
          if [ -f "atlantis.yaml" ]; then
            echo "ğŸ” atlantis.yaml íŒŒì¼ ê²€ì¦ ì¤‘..."
            
            # YAML êµ¬ë¬¸ ê²€ì¦
            if command -v yamllint &> /dev/null; then
              yamllint atlantis.yaml
            else
              echo "yamllintê°€ ì—†ì–´ Python yamlë¡œ ê²€ì¦í•©ë‹ˆë‹¤"
              python3 -c "import yaml; yaml.safe_load(open('atlantis.yaml'))"
            fi
            
            # í•„ìˆ˜ í•„ë“œ ê²€ì¦
            echo "ğŸ“‹ í•„ìˆ˜ í•„ë“œ í™•ì¸ ì¤‘..."
            
            if ! grep -q "version:" atlantis.yaml; then
              echo "âŒ 'version' í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤"
              exit 1
            fi
            
            if ! grep -q "projects:" atlantis.yaml; then
              echo "âŒ 'projects' í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤"  
              exit 1
            fi
            
            echo "âœ… atlantis.yaml êµ¬ë¬¸ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤"
          else
            echo "âš ï¸ atlantis.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi