# StackKit Simple Terraform Validation
# ê¸°ë³¸ì ì¸ Terraform ê²€ì¦ë§Œ ìˆ˜í–‰í•˜ëŠ” ê°„ë‹¨í•œ ì›Œí¬í”Œë¡œìš°

name: âœ… Simple Terraform Check

on:
  pull_request:
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tfvars'
  push:
    branches: [main, develop]
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tfvars'

env:
  TF_VERSION: "1.8.5"

jobs:
  terraform-check:
    name: ğŸ” Terraform ê¸°ë³¸ ê²€ì¦
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ë³€ê²½ëœ Terraform ë””ë ‰í† ë¦¬ ì°¾ê¸°
        id: changed-dirs
        run: |
          # ë³€ê²½ëœ íŒŒì¼ì—ì„œ Terraform ë””ë ‰í† ë¦¬ ì¶”ì¶œ
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            changed_files=$(git diff --name-only origin/${{ github.base_ref }}..HEAD)
          else
            changed_files=$(git diff --name-only HEAD^ HEAD)
          fi
          
          dirs=()
          for file in $changed_files; do
            if [[ $file == terraform/stacks/* && $file == *.tf ]]; then
              dir=$(dirname "$file")
              if [[ ! " ${dirs[@]} " =~ " ${dir} " ]]; then
                dirs+=("$dir")
              fi
            fi
          done
          
          if [ ${#dirs[@]} -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            dirs_json=$(printf '%s\n' "${dirs[@]}" | jq -R . | jq -s .)
            echo "dirs=${dirs_json}" >> $GITHUB_OUTPUT
            echo "Changed directories: ${dirs[*]}"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No Terraform changes detected"
          fi

      - name: Terraform Format Check
        if: steps.changed-dirs.outputs.has_changes == 'true'
        run: |
          echo "ğŸ¨ Checking Terraform formatting..."
          terraform fmt -check -recursive -diff terraform/ || {
            echo "âŒ Terraform files are not properly formatted"
            echo "Run 'terraform fmt -recursive terraform/' to fix"
            exit 1
          }

      - name: Terraform Validate
        if: steps.changed-dirs.outputs.has_changes == 'true'
        run: |
          echo "âœ… Validating Terraform configurations..."
          dirs='${{ steps.changed-dirs.outputs.dirs }}'
          
          for dir in $(echo $dirs | jq -r '.[]'); do
            echo "Validating: $dir"
            cd "$dir"
            
            # ê°„ë‹¨í•œ ì´ˆê¸°í™” (ë°±ì—”ë“œ ì—†ì´)
            terraform init -backend=false
            terraform validate
            
            cd - > /dev/null
          done

      - name: StackKit ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦
        if: steps.changed-dirs.outputs.has_changes == 'true'
        run: |
          echo "ğŸ›¡ï¸ Running StackKit validation scripts..."
          
          # StackKit ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
          if [ -f "terraform/scripts/validate.sh" ]; then
            dirs='${{ steps.changed-dirs.outputs.dirs }}'
            
            for dir in $(echo $dirs | jq -r '.[]'); do
              # ìŠ¤íƒ ê²½ë¡œì—ì„œ í”„ë¡œì íŠ¸ëª…ê³¼ í™˜ê²½ ì¶”ì¶œ
              if [[ $dir =~ terraform/stacks/([^/]+)/([^/]+) ]]; then
                project="${BASH_REMATCH[1]}"
                env="${BASH_REMATCH[2]}"
                
                echo "Validating stack: $project $env"
                bash terraform/scripts/validate.sh "$project" "$env" --quick || true
              fi
            done
          else
            echo "No StackKit validation script found, skipping..."
          fi

      - name: ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          if [[ "${{ steps.changed-dirs.outputs.has_changes }}" == "true" ]]; then
            echo "âœ… Terraform ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "â„¹ï¸ Terraform ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ê²€ì¦ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤."
          fi