# StackKit PR Plan & Cost Estimation Workflow
# PRì—ì„œ Terraform Planê³¼ ë¹„ìš© ì¶”ì •ì„ ìˆ˜í–‰í•˜ê³  ê²°ê³¼ë¥¼ ì½”ë©˜íŠ¸ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.

name: ğŸ“‹ Terraform PR Plan & Cost

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tfvars'
      - 'terraform/**/*.hcl'

env:
  TF_VERSION: "1.8.5"
  AWS_REGION: "ap-northeast-2"
  INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  plan-and-cost:
    name: ğŸ“‹ Plan & ğŸ’° Cost Estimation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup Infracost
        if: env.INFRACOST_API_KEY != ''
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ env.INFRACOST_API_KEY }}

      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ë³€ê²½ëœ Terraform ìŠ¤íƒ ê°ì§€
        id: detect
        run: |
          # PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ ë¶„ì„
          echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ ë¶„ì„ ì¤‘..."
          
          changed_files=$(git diff --name-only origin/${{ github.base_ref }}..HEAD)
          
          # ë³€ê²½ëœ Terraform ìŠ¤íƒ ë””ë ‰í† ë¦¬ë“¤ ì¶”ì¶œ
          declare -A stacks
          for file in $changed_files; do
            if [[ $file =~ ^terraform/stacks/([^/]+/[^/]+)/ ]]; then
              stack_dir="terraform/stacks/${BASH_REMATCH[1]}"
              stacks["$stack_dir"]=1
              echo "ğŸ“ ê°ì§€ëœ ìŠ¤íƒ: $stack_dir"
            fi
          done
          
          if [ ${#stacks[@]} -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Terraform ìŠ¤íƒ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # ìŠ¤íƒ ëª©ë¡ì„ ë°°ì—´ë¡œ ì €ì¥
          stack_list=""
          for stack in "${!stacks[@]}"; do
            if [ -z "$stack_list" ]; then
              stack_list="$stack"
            else
              stack_list="$stack_list $stack"
            fi
          done
          echo "stacks=$stack_list" >> $GITHUB_OUTPUT

      - name: Terraform Plan ë° ë¹„ìš© ì¶”ì •
        if: steps.detect.outputs.has_changes == 'true'
        id: plan
        run: |
          echo "ğŸ—ï¸ Terraform Plan ë° ë¹„ìš© ì¶”ì • ì‹œì‘"
          
          # ê²°ê³¼ ì €ì¥ì„ ìœ„í•œ ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /tmp/plan_results
          
          OVERALL_SUCCESS=true
          STACKS="${{ steps.detect.outputs.stacks }}"
          
          for stack in $STACKS; do
            echo ""
            echo "===================================================="
            echo "ğŸ—ï¸ ì²˜ë¦¬ ì¤‘ì¸ ìŠ¤íƒ: $stack"
            echo "===================================================="
            
            if [ ! -d "$stack" ]; then
              echo "âš ï¸ ìŠ¤íƒ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $stack"
              continue
            fi
            
            cd "$stack"
            stack_name=$(basename "$stack")
            result_file="/tmp/plan_results/${stack_name}.json"
            
            # ìŠ¤íƒ ê²°ê³¼ ì´ˆê¸°í™”
            echo '{"stack":"'$stack'","success":false,"has_changes":false}' > "$result_file"
            
            echo "ğŸ“ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
            
            # Terraform ì´ˆê¸°í™”
            echo "âš¡ Terraform ì´ˆê¸°í™”..."
            if [ -f "backend.hcl" ]; then
              terraform init -backend-config=backend.hcl -input=false
            else
              terraform init -input=false
            fi
            
            if [ $? -ne 0 ]; then
              echo "âŒ Terraform ì´ˆê¸°í™” ì‹¤íŒ¨"
              OVERALL_SUCCESS=false
              cd - > /dev/null
              continue
            fi
            
            # Terraform Plan ì‹¤í–‰
            echo "ğŸ“‹ Terraform Plan ì‹¤í–‰..."
            
            # tfvars íŒŒì¼ ì°¾ê¸°
            TFVARS_ARG=""
            if [ -f "terraform.tfvars" ]; then
              TFVARS_ARG="-var-file=terraform.tfvars"
              echo "ğŸ“„ ì‚¬ìš©í•  ë³€ìˆ˜ íŒŒì¼: terraform.tfvars"
            elif [ -f "dev.tfvars" ]; then
              TFVARS_ARG="-var-file=dev.tfvars"
              echo "ğŸ“„ ì‚¬ìš©í•  ë³€ìˆ˜ íŒŒì¼: dev.tfvars"
            elif [ -f "prod.tfvars" ]; then
              TFVARS_ARG="-var-file=prod.tfvars"
              echo "ğŸ“„ ì‚¬ìš©í•  ë³€ìˆ˜ íŒŒì¼: prod.tfvars"
            fi
            
            terraform plan $TFVARS_ARG -out=tfplan -detailed-exitcode -input=false
            PLAN_EXIT_CODE=$?
            
            if [ $PLAN_EXIT_CODE -eq 1 ]; then
              echo "âŒ Terraform Plan ì‹¤í–‰ ì‹¤íŒ¨"
              OVERALL_SUCCESS=false
              cd - > /dev/null
              continue
            fi
            
            # Plan ê²°ê³¼ë¥¼ í…ìŠ¤íŠ¸ì™€ JSONìœ¼ë¡œ ì €ì¥
            terraform show -no-color tfplan > plan.txt
            terraform show -json tfplan > plan.json
            
            # Plan ë³€ê²½ì‚¬í•­ ì—¬ë¶€ í™•ì¸
            HAS_CHANGES="false"
            if [ $PLAN_EXIT_CODE -eq 2 ]; then
              HAS_CHANGES="true"
              echo "ğŸ“ ì¸í”„ë¼ ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤"
            else
              echo "âœ… ì¸í”„ë¼ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
            fi
            
            # ë¹„ìš© ì¶”ì • (Infracost)
            MONTHLY_COST="0"
            if [ "${{ env.INFRACOST_API_KEY }}" != "" ] && [ -f "tfplan" ]; then
              echo "ğŸ’° Infracost ë¹„ìš© ì¶”ì • ì‹¤í–‰..."
              
              infracost breakdown \
                --path . \
                --terraform-plan-path tfplan \
                --format json \
                --out-file infracost.json 2>/dev/null || echo '{"totalMonthlyCost":"0"}' > infracost.json
              
              # ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ í˜•íƒœë¡œë„ ìƒì„±
              infracost breakdown \
                --path . \
                --terraform-plan-path tfplan \
                --format table > infracost.txt 2>/dev/null || echo "ë¹„ìš© ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." > infracost.txt
              
              MONTHLY_COST=$(jq -r '.totalMonthlyCost // "0"' infracost.json)
              echo "ğŸ’° ì˜ˆìƒ ì›”ê°„ ë¹„ìš©: \$${MONTHLY_COST} USD"
            else
              echo "â„¹ï¸ Infracost ë¹„ìš© ì¶”ì •ì„ ê±´ë„ˆëœë‹ˆë‹¤ (API í‚¤ ì—†ìŒ ë˜ëŠ” Plan íŒŒì¼ ì—†ìŒ)"
            fi
            
            # ê²°ê³¼ JSON ì—…ë°ì´íŠ¸
            jq --arg cost "$MONTHLY_COST" --argjson has_changes "$HAS_CHANGES" \
               '.success=true | .monthly_cost=$cost | .has_changes=$has_changes' \
               "$result_file" > "${result_file}.tmp" && mv "${result_file}.tmp" "$result_file"
            
            echo "âœ… ìŠ¤íƒ ì²˜ë¦¬ ì™„ë£Œ: $stack"
            cd - > /dev/null
          done
          
          # ì „ì²´ ê²°ê³¼ ìˆ˜ì§‘
          echo ""
          echo "ğŸ“Š ì „ì²´ ê²°ê³¼ ìˆ˜ì§‘ ì¤‘..."
          
          TOTAL_COST=0
          CHANGED_STACKS=0
          TOTAL_STACKS=0
          
          for result_file in /tmp/plan_results/*.json; do
            if [ -f "$result_file" ]; then
              TOTAL_STACKS=$((TOTAL_STACKS + 1))
              
              if [ "$(jq -r '.has_changes' "$result_file")" = "true" ]; then
                CHANGED_STACKS=$((CHANGED_STACKS + 1))
              fi
              
              cost=$(jq -r '.monthly_cost // "0"' "$result_file")
              if [ "$cost" != "0" ] && [ "$cost" != "null" ]; then
                TOTAL_COST=$(echo "$TOTAL_COST + $cost" | bc -l)
              fi
            fi
          done
          
          echo "overall_success=$OVERALL_SUCCESS" >> $GITHUB_OUTPUT
          echo "total_cost=$TOTAL_COST" >> $GITHUB_OUTPUT
          echo "changed_stacks=$CHANGED_STACKS" >> $GITHUB_OUTPUT
          echo "total_stacks=$TOTAL_STACKS" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“Š ìµœì¢… ìš”ì•½:"
          echo "- ì „ì²´ ìŠ¤íƒ: $TOTAL_STACKS"
          echo "- ë³€ê²½ëœ ìŠ¤íƒ: $CHANGED_STACKS"
          echo "- ì´ ì˜ˆìƒ ë¹„ìš©: \$${TOTAL_COST} USD/ì›”"

      - name: PR ì½”ë©˜íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸
        if: steps.detect.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // ê²°ê³¼ íŒŒì¼ë“¤ ì½ê¸°
            const resultsDir = '/tmp/plan_results';
            let allResults = [];
            
            if (fs.existsSync(resultsDir)) {
              const files = fs.readdirSync(resultsDir).filter(f => f.endsWith('.json'));
              
              for (const file of files) {
                try {
                  const content = fs.readFileSync(path.join(resultsDir, file), 'utf8');
                  const result = JSON.parse(content);
                  allResults.push(result);
                } catch (error) {
                  console.error(`ê²°ê³¼ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${file}`, error);
                }
              }
            }
            
            const totalCost = '${{ steps.plan.outputs.total_cost }}';
            const changedStacks = '${{ steps.plan.outputs.changed_stacks }}';
            const totalStacks = '${{ steps.plan.outputs.total_stacks }}';
            const overallSuccess = '${{ steps.plan.outputs.overall_success }}';
            
            // ì½”ë©˜íŠ¸ ë‚´ìš© ìƒì„±
            let comment = `## ğŸ“‹ Terraform Plan & ğŸ’° Cost Estimation\n\n`;
            
            // ì „ì²´ ìš”ì•½
            comment += `### ğŸ“Š ìš”ì•½\n`;
            comment += `| í•­ëª© | ê°’ |\n`;
            comment += `|------|----|\n`;
            comment += `| ğŸ—ï¸ ì „ì²´ ìŠ¤íƒ | ${totalStacks}ê°œ |\n`;
            comment += `| ğŸ“ ë³€ê²½ëœ ìŠ¤íƒ | ${changedStacks}ê°œ |\n`;
            comment += `| ğŸ’° ì´ ì˜ˆìƒ ë¹„ìš© | $${totalCost} USD/ì›” |\n`;
            comment += `| âœ… ì „ì²´ ìƒíƒœ | ${overallSuccess === 'true' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'} |\n\n`;
            
            // ìŠ¤íƒë³„ ìƒì„¸ ê²°ê³¼
            if (allResults.length > 0) {
              comment += `### ğŸ—ï¸ ìŠ¤íƒë³„ ìƒì„¸ ê²°ê³¼\n\n`;
              
              for (const result of allResults) {
                const stackName = path.basename(result.stack);
                const status = result.success ? 'âœ…' : 'âŒ';
                const changes = result.has_changes ? 'ğŸ“ ë³€ê²½ë¨' : 'â– ë³€ê²½ì—†ìŒ';
                const cost = result.monthly_cost && result.monthly_cost !== '0' ? 
                  `$${result.monthly_cost} USD/ì›”` : 'ë¬´ë£Œ';
                
                comment += `#### ${status} \`${stackName}\`\n`;
                comment += `- **ìƒíƒœ**: ${result.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}\n`;
                comment += `- **ë³€ê²½ì‚¬í•­**: ${changes}\n`;
                comment += `- **ì˜ˆìƒ ë¹„ìš©**: ${cost}\n`;
                
                // Plan ê²°ê³¼ íŒŒì¼ì´ ìˆìœ¼ë©´ ìƒì„¸ ì •ë³´ ì¶”ê°€
                const stackDir = result.stack;
                const planFile = path.join(stackDir, 'plan.txt');
                const costFile = path.join(stackDir, 'infracost.txt');
                
                if (fs.existsSync(planFile)) {
                  const planContent = fs.readFileSync(planFile, 'utf8');
                  const truncatedPlan = planContent.length > 3000 ? 
                    planContent.substring(0, 3000) + '\n\n... (ê²°ê³¼ê°€ ì˜ë ¸ìŠµë‹ˆë‹¤)' : 
                    planContent;
                  
                  comment += `\n<details>\n<summary>ğŸ“‹ Terraform Plan ìƒì„¸</summary>\n\n\`\`\`hcl\n${truncatedPlan}\n\`\`\`\n</details>\n`;
                }
                
                if (fs.existsSync(costFile) && result.monthly_cost && result.monthly_cost !== '0') {
                  const costContent = fs.readFileSync(costFile, 'utf8');
                  comment += `\n<details>\n<summary>ğŸ’° ë¹„ìš© ìƒì„¸ ë¶„ì„</summary>\n\n\`\`\`\n${costContent}\n\`\`\`\n</details>\n`;
                }
                
                comment += `\n`;
              }
            }
            
            comment += `---\n`;
            comment += `*ğŸ¤– ìë™ ìƒì„±ëœ StackKit Plan ê²°ê³¼ | ì‹¤í–‰ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}*\n`;
            comment += `*ğŸ’¡ ì´ ê²°ê³¼ëŠ” ì˜ˆìƒ ê°’ì´ë©°, ì‹¤ì œ ë¹„ìš©ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.*`;
            
            // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Terraform Plan & ğŸ’° Cost Estimation')
            );
            
            if (existingComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
              console.log('ê¸°ì¡´ PR ì½”ë©˜íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.');
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('ìƒˆë¡œìš´ PR ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.');
            }

      - name: ê²€ì¦ ê²°ê³¼ì— ë”°ë¥¸ ì¢…ë£Œ
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          if [[ "${{ steps.plan.outputs.overall_success }}" == "true" ]]; then
            echo "âœ… ëª¨ë“  Terraform Planì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ“Š ë³€ê²½ëœ ìŠ¤íƒ: ${{ steps.plan.outputs.changed_stacks }}/${{ steps.plan.outputs.total_stacks }}"
            echo "ğŸ’° ì´ ì˜ˆìƒ ë¹„ìš©: \$${{ steps.plan.outputs.total_cost }} USD/ì›”"
            exit 0
          else
            echo "âŒ ì¼ë¶€ Terraform Planì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            echo "ìƒì„¸ ë‚´ìš©ì€ ìœ„ì˜ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            exit 1
          fi

      - name: ë³€ê²½ì‚¬í•­ ì—†ìŒ ì•Œë¦¼
        if: steps.detect.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸ Terraform ê´€ë ¨ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          echo "ê²€ì¦ì„ ê±´ë„ˆëœë‹ˆë‹¤."