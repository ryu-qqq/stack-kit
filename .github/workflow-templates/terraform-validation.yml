# StackKit Terraform Validation Workflow
# ëª¨ë“  Terraform ì½”ë“œì— ëŒ€í•œ ì¢…í•©ì ì¸ ê²€ì¦ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

name: ğŸ” Terraform Validation

on:
  pull_request:
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tfvars'
      - '.github/workflows/terraform-validation.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tfvars'

env:
  TF_VERSION: "1.8.5"
  AWS_REGION: "ap-northeast-2"
  # Infracost API í‚¤ ì„¤ì • (Repository Secretsì—ì„œ ì„¤ì •)
  INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}

permissions:
  contents: read
  pull-requests: write
  id-token: write  # AWS OIDCë¥¼ ìœ„í•œ ê¶Œí•œ

jobs:
  detect-changes:
    name: ğŸ” ë³€ê²½ëœ Terraform ìŠ¤íƒ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      stacks: ${{ steps.changes.outputs.stacks }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë³€ê²½ëœ Terraform ìŠ¤íƒ ê°ì§€
        id: changes
        run: |
          # ë³€ê²½ëœ íŒŒì¼ë“¤ì—ì„œ Terraform ìŠ¤íƒ ë””ë ‰í† ë¦¬ ì¶”ì¶œ
          changed_files=$(git diff --name-only origin/${{ github.base_ref }}..HEAD || echo "")
          
          # Terraform íŒŒì¼ì´ ë³€ê²½ëœ ìŠ¤íƒë“¤ ì°¾ê¸°
          stacks=()
          for file in $changed_files; do
            if [[ $file =~ ^terraform/stacks/([^/]+)/([^/]+)/ ]]; then
              stack_path="terraform/stacks/${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
              if [[ ! " ${stacks[@]} " =~ " ${stack_path} " ]]; then
                stacks+=("$stack_path")
              fi
            fi
          done
          
          if [ ${#stacks[@]} -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # JSON ë°°ì—´ë¡œ ë³€í™˜
            stacks_json=$(printf '%s\n' "${stacks[@]}" | jq -R . | jq -s .)
            echo "stacks=$stacks_json" >> $GITHUB_OUTPUT
            echo "âœ… ê°ì§€ëœ Terraform ìŠ¤íƒë“¤:"
            printf '%s\n' "${stacks[@]}"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "stacks=[]" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ë³€ê²½ëœ Terraform ìŠ¤íƒì´ ì—†ìŠµë‹ˆë‹¤."
          fi

  terraform-validation:
    name: ğŸ§ª Terraform ê²€ì¦
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        stack: ${{ fromJson(needs.detect-changes.outputs.stacks) }}
      fail-fast: false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Option 1: IAM Role (ê¶Œì¥)
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          # Option 2: IAM User (ëŒ€ì•ˆ)
          # aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          # aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Infracost
        if: env.INFRACOST_API_KEY != ''
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ env.INFRACOST_API_KEY }}

      - name: ìŠ¤íƒ ì •ë³´ í‘œì‹œ
        run: |
          echo "ğŸ—ï¸ ê²€ì¦ ì¤‘ì¸ ìŠ¤íƒ: ${{ matrix.stack }}"
          echo "ğŸ“ ê²½ë¡œ: $(pwd)/${{ matrix.stack }}"
          ls -la "${{ matrix.stack }}" || echo "âš ï¸ ìŠ¤íƒ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

      - name: Terraform Format Check
        id: fmt
        working-directory: ${{ matrix.stack }}
        run: |
          echo "::group::ğŸ¨ Terraform Format ê²€ì‚¬"
          terraform fmt -check -recursive -diff
          echo "::endgroup::"
        continue-on-error: true

      - name: Terraform Init
        id: init
        working-directory: ${{ matrix.stack }}
        run: |
          echo "::group::âš¡ Terraform ì´ˆê¸°í™”"
          # S3 ë°±ì—”ë“œ ì„¤ì •ì´ ìˆëŠ” ê²½ìš° ì´ˆê¸°í™”
          if [ -f "backend.hcl" ]; then
            terraform init -backend-config=backend.hcl
          else
            terraform init
          fi
          echo "::endgroup::"

      - name: Terraform Validate
        id: validate
        working-directory: ${{ matrix.stack }}
        run: |
          echo "::group::âœ… Terraform êµ¬ë¬¸ ê²€ì¦"
          terraform validate
          echo "::endgroup::"

      - name: Terraform Plan
        id: plan
        working-directory: ${{ matrix.stack }}
        run: |
          echo "::group::ğŸ“‹ Terraform Plan ìƒì„±"
          # tfvars íŒŒì¼ ì°¾ê¸°
          if [ -f "terraform.tfvars" ]; then
            TFVARS_ARG="-var-file=terraform.tfvars"
          elif [ -f "dev.tfvars" ]; then
            TFVARS_ARG="-var-file=dev.tfvars"
          else
            TFVARS_ARG=""
          fi
          
          terraform plan $TFVARS_ARG -out=tfplan -detailed-exitcode
          PLAN_EXIT_CODE=$?
          
          # Plan ê²°ê³¼ë¥¼ í…ìŠ¤íŠ¸ì™€ JSONìœ¼ë¡œ ì €ì¥
          terraform show -no-color tfplan > plan_output.txt
          terraform show -json tfplan > plan_output.json
          
          echo "plan_exit_code=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT
          echo "::endgroup::"
        continue-on-error: true

      - name: StackKit ë³´ì•ˆ ê²€ì¦
        id: security
        working-directory: ${{ matrix.stack }}
        run: |
          echo "::group::ğŸ›¡ï¸ StackKit ë³´ì•ˆ ê²€ì¦"
          
          # StackKit ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ ì°¾ê¸°
          VALIDATION_SCRIPT="$(pwd)/../../scripts/validate.sh"
          if [ ! -f "$VALIDATION_SCRIPT" ]; then
            VALIDATION_SCRIPT="../../../scripts/validate.sh"
          fi
          
          if [ -f "$VALIDATION_SCRIPT" ]; then
            # ìŠ¤íƒ ì´ë¦„ ì¶”ì¶œ (terraform/stacks/project/env -> project env)
            STACK_PATH="${{ matrix.stack }}"
            PROJECT_NAME=$(echo "$STACK_PATH" | cut -d'/' -f3)
            ENVIRONMENT=$(echo "$STACK_PATH" | cut -d'/' -f4)
            
            echo "ğŸ“Š ë³´ì•ˆ ê²€ì¦ ì‹¤í–‰: $PROJECT_NAME $ENVIRONMENT"
            bash "$VALIDATION_SCRIPT" "$PROJECT_NAME" "$ENVIRONMENT" --security-only || true
          else
            echo "âš ï¸ StackKit ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
          echo "::endgroup::"

      - name: ë¹„ìš© ì¶”ì • (Infracost)
        id: cost
        if: env.INFRACOST_API_KEY != ''
        working-directory: ${{ matrix.stack }}
        run: |
          echo "::group::ğŸ’° ì¸í”„ë¼ ë¹„ìš© ì¶”ì •"
          
          if [ -f "tfplan" ]; then
            # Infracost ë¹„ìš© ì¶”ì •
            infracost breakdown \
              --path . \
              --terraform-plan-path tfplan \
              --format json \
              --out-file infracost.json
            
            # ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ í˜•íƒœë¡œë„ ìƒì„±
            infracost breakdown \
              --path . \
              --terraform-plan-path tfplan \
              --format table > infracost_output.txt
            
            # ì›”ê°„ ë¹„ìš© ì¶”ì¶œ
            MONTHLY_COST=$(jq -r '.totalMonthlyCost // "0"' infracost.json)
            echo "monthly_cost=$MONTHLY_COST" >> $GITHUB_OUTPUT
            
            echo "ğŸ’° ì˜ˆìƒ ì›”ê°„ ë¹„ìš©: \$$MONTHLY_COST USD"
          else
            echo "âš ï¸ Terraform Plan íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ë¹„ìš© ì¶”ì •ì„ ê±´ë„ˆëœë‹ˆë‹¤"
          fi
          echo "::endgroup::"

      - name: PR ì½”ë©˜íŠ¸ ìƒì„±
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const stackPath = '${{ matrix.stack }}';
            const stackName = stackPath.replace('terraform/stacks/', '');
            
            // ê²°ê³¼ ìˆ˜ì§‘
            const fmt = '${{ steps.fmt.outcome }}';
            const validate = '${{ steps.validate.outcome }}';
            const planExitCode = '${{ steps.plan.outputs.plan_exit_code }}';
            const monthlyCost = '${{ steps.cost.outputs.monthly_cost }}';
            
            let comment = `## ğŸ” Terraform ê²€ì¦ ê²°ê³¼ - \`${stackName}\`\n\n`;
            
            // ê²€ì¦ ê²°ê³¼ í…Œì´ë¸”
            comment += `| ê²€ì‚¬ í•­ëª© | ê²°ê³¼ |\n`;
            comment += `|----------|------|\n`;
            comment += `| ğŸ¨ Format | ${fmt === 'success' ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨'} |\n`;
            comment += `| âœ… Validate | ${validate === 'success' ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨'} |\n`;
            comment += `| ğŸ“‹ Plan | ${planExitCode === '0' ? 'âœ… ë³€ê²½ì‚¬í•­ ì—†ìŒ' : planExitCode === '2' ? 'ğŸ“ ë³€ê²½ì‚¬í•­ ìˆìŒ' : 'âŒ ì‹¤íŒ¨'} |\n`;
            
            if (monthlyCost && monthlyCost !== '0') {
              comment += `| ğŸ’° ì˜ˆìƒ ë¹„ìš© | $${monthlyCost} USD/ì›” |\n`;
            }
            
            comment += '\n';
            
            // Plan ê²°ê³¼ê°€ ìˆìœ¼ë©´ ìš”ì•½ ì¶”ê°€
            const planOutputPath = path.join('${{ matrix.stack }}', 'plan_output.txt');
            if (fs.existsSync(planOutputPath)) {
              const planOutput = fs.readFileSync(planOutputPath, 'utf8');
              const truncatedPlan = planOutput.length > 8000 ? 
                planOutput.substring(0, 8000) + '\n\n... (ê²°ê³¼ê°€ ì˜ë ¸ìŠµë‹ˆë‹¤. ì „ì²´ ê²°ê³¼ëŠ” Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”)' : 
                planOutput;
              
              comment += `<details>\n<summary>ğŸ“‹ Terraform Plan ìƒì„¸ ê²°ê³¼</summary>\n\n\`\`\`terraform\n${truncatedPlan}\n\`\`\`\n</details>\n\n`;
            }
            
            // Infracost ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì¶”ê°€
            const costOutputPath = path.join('${{ matrix.stack }}', 'infracost_output.txt');
            if (fs.existsSync(costOutputPath)) {
              const costOutput = fs.readFileSync(costOutputPath, 'utf8');
              comment += `<details>\n<summary>ğŸ’° ë¹„ìš© ìƒì„¸ ë¶„ì„</summary>\n\n\`\`\`\n${costOutput}\n\`\`\`\n</details>\n\n`;
            }
            
            comment += `---\n*ğŸ¤– StackKit ìë™ ê²€ì¦ by GitHub Actions*`;
            
            // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes(`Terraform ê²€ì¦ ê²°ê³¼ - \`${stackName}\``)
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  summary:
    name: ğŸ“Š ê²€ì¦ ê²°ê³¼ ìš”ì•½
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-validation]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    
    steps:
      - name: ê²€ì¦ ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ğŸ” Terraform ê²€ì¦ ì™„ë£Œ"
          echo ""
          echo "ê²€ì¦ëœ ìŠ¤íƒ ìˆ˜: $(echo '${{ needs.detect-changes.outputs.stacks }}' | jq length)"
          echo ""
          
          if [[ "${{ needs.terraform-validation.result }}" == "success" ]]; then
            echo "âœ… ëª¨ë“  ê²€ì¦ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
            exit 0
          else
            echo "âŒ ì¼ë¶€ ê²€ì¦ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
            exit 1
          fi