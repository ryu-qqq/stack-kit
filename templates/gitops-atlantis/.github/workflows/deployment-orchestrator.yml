name: Deployment Orchestrator

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        options:
          - dev-pr
          - staging
          - production
        required: true
      version:
        description: 'Version to deploy (for staging/prod)'
        type: string
        required: false
      pr_number:
        description: 'PR number (for dev-pr environment)'
        type: string
        required: false
      deployment_strategy:
        description: 'Deployment strategy'
        type: choice
        options:
          - standard
          - blue-green
          - canary
          - rollback
        default: 'standard'
      skip_tests:
        description: 'Skip automated tests (emergency only)'
        type: boolean
        default: false

env:
  AWS_REGION: ap-northeast-2

jobs:
  # ë°°í¬ ì‚¬ì „ ê²€ì¦
  pre-deployment-validation:
    name: ğŸ” Pre-deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      validation-passed: ${{ steps.validate.outputs.passed }}
      deployment-plan: ${{ steps.plan.outputs.strategy }}

    steps:
    - name: Validate deployment request
      id: validate
      run: |
        echo "ğŸ” Validating deployment request..."

        ENVIRONMENT="${{ github.event.inputs.environment }}"
        VERSION="${{ github.event.inputs.version }}"
        PR_NUMBER="${{ github.event.inputs.pr_number }}"
        STRATEGY="${{ github.event.inputs.deployment_strategy }}"

        # í™˜ê²½ë³„ ìœ íš¨ì„± ê²€ì‚¬
        if [ "$ENVIRONMENT" = "dev-pr" ]; then
          if [ -z "$PR_NUMBER" ]; then
            echo "âŒ PR number required for dev-pr environment"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "âœ… Dev-PR deployment validation passed"
        elif [ "$ENVIRONMENT" = "staging" ] || [ "$ENVIRONMENT" = "production" ]; then
          if [ -z "$VERSION" ] && [ "$STRATEGY" != "rollback" ]; then
            echo "âŒ Version required for $ENVIRONMENT deployment"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "âœ… $ENVIRONMENT deployment validation passed"
        fi

        # ì „ëµë³„ ìœ íš¨ì„± ê²€ì‚¬
        if [ "$STRATEGY" = "blue-green" ] && [ "$ENVIRONMENT" != "production" ]; then
          echo "âš ï¸ Blue-green strategy recommended for production only"
        fi

        echo "passed=true" >> $GITHUB_OUTPUT

    - name: Generate deployment plan
      id: plan
      run: |
        ENVIRONMENT="${{ github.event.inputs.environment }}"
        STRATEGY="${{ github.event.inputs.deployment_strategy }}"

        echo "ğŸ“‹ Generating deployment plan..."

        case "$ENVIRONMENT" in
          "dev-pr")
            PLAN="ephemeral-dev"
            echo "ğŸ¯ Plan: Ephemeral development environment"
            ;;
          "staging")
            PLAN="staging-validation"
            echo "ğŸ¯ Plan: Staging validation deployment"
            ;;
          "production")
            case "$STRATEGY" in
              "blue-green")
                PLAN="prod-blue-green"
                echo "ğŸ¯ Plan: Production blue-green deployment"
                ;;
              "canary")
                PLAN="prod-canary"
                echo "ğŸ¯ Plan: Production canary deployment"
                ;;
              "rollback")
                PLAN="prod-rollback"
                echo "ğŸ¯ Plan: Production rollback"
                ;;
              *)
                PLAN="prod-standard"
                echo "ğŸ¯ Plan: Production standard deployment"
                ;;
            esac
            ;;
        esac

        echo "strategy=$PLAN" >> $GITHUB_OUTPUT

  # Dev í™˜ê²½ ë°°í¬
  deploy-dev:
    name: ğŸš€ Deploy to Dev Environment
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    if: github.event.inputs.environment == 'dev-pr' && needs.pre-deployment-validation.outputs.validation-passed == 'true'
    timeout-minutes: 15

    steps:
    - name: Trigger dev deployment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Dev í™˜ê²½ ë°°í¬ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
          const response = await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'dev-ephemeral-deploy.yml',
            ref: 'main',
            inputs: {
              pr_number: '${{ github.event.inputs.pr_number }}'
            }
          });

          console.log('ğŸš€ Dev deployment triggered');

  # Staging í™˜ê²½ ë°°í¬
  deploy-staging:
    name: ğŸ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    if: github.event.inputs.environment == 'staging' && needs.pre-deployment-validation.outputs.validation-passed == 'true'
    timeout-minutes: 25

    environment:
      name: staging
      url: https://staging.ORG_NAME_PLACEHOLDER.com

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_STAGING_DEPLOY_ROLE_ARN }}
        role-session-name: GitHubActions-Staging-${{ github.run_id }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to staging
      run: |
        echo "ğŸ­ Deploying to staging environment..."

        VERSION="${{ github.event.inputs.version }}"
        NAMESPACE="staging"
        APP_NAME="ORG_NAME_PLACEHOLDER-staging"

        # ì´ë¯¸ì§€ URI êµ¬ì„±
        IMAGE_URI="${{ secrets.ECR_REGISTRY }}/ORG_NAME_PLACEHOLDER-prod:$VERSION"

        echo "ğŸ“¦ Deploying version: $VERSION"
        echo "ğŸ¯ Target: $NAMESPACE"

        # Staging ë°°í¬ (ë‹¨ìˆœí•œ ë¡¤ë§ ì—…ë°ì´íŠ¸)
        kubectl set image deployment/$APP_NAME -n $NAMESPACE app=$IMAGE_URI

        # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
        kubectl rollout status deployment/$APP_NAME -n $NAMESPACE --timeout=600s

        echo "âœ… Staging deployment completed"

    - name: Run staging tests
      if: github.event.inputs.skip_tests != 'true'
      run: |
        echo "ğŸ§ª Running staging tests..."

        # í—¬ìŠ¤ì²´í¬
        curl -f https://staging.ORG_NAME_PLACEHOLDER.com/health

        # ê¸°ë³¸ API í…ŒìŠ¤íŠ¸
        curl -f https://staging.ORG_NAME_PLACEHOLDER.com/api/v1/status

        # í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ì‹¤í–‰)
        echo "âœ… Staging tests passed"

  # Production í™˜ê²½ ë°°í¬
  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    if: github.event.inputs.environment == 'production' && needs.pre-deployment-validation.outputs.validation-passed == 'true'
    timeout-minutes: 45

    environment:
      name: production
      url: https://ORG_NAME_PLACEHOLDER.com

    steps:
    - name: Production deployment approval
      run: |
        echo "ğŸ”’ Production deployment requires approval"
        echo "ğŸ“¦ Version: ${{ github.event.inputs.version }}"
        echo "ğŸ¯ Strategy: ${{ github.event.inputs.deployment_strategy }}"

    - name: Execute production deployment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const strategy = '${{ github.event.inputs.deployment_strategy }}';
          const version = '${{ github.event.inputs.version }}';

          // Production ë°°í¬ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
          let workflowFile = 'prod-deploy.yml';
          let inputs = { version: version };

          if (strategy === 'rollback') {
            inputs.rollback_version = version;
          }

          const response = await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: workflowFile,
            ref: 'main',
            inputs: inputs
          });

          console.log('ğŸš€ Production deployment triggered');

  # ë°°í¬ í›„ ê²€ì¦
  post-deployment-verification:
    name: âœ… Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, deploy-dev, deploy-staging, deploy-production]
    if: always() && (needs.deploy-dev.result == 'success' || needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    timeout-minutes: 15

    steps:
    - name: Verify deployment health
      run: |
        ENVIRONMENT="${{ github.event.inputs.environment }}"

        echo "âœ… Running post-deployment verification for $ENVIRONMENT..."

        case "$ENVIRONMENT" in
          "dev-pr")
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            HEALTH_URL="https://pr-${PR_NUMBER}.dev.ORG_NAME_PLACEHOLDER.com/health"
            ;;
          "staging")
            HEALTH_URL="https://staging.ORG_NAME_PLACEHOLDER.com/health"
            ;;
          "production")
            HEALTH_URL="https://ORG_NAME_PLACEHOLDER.com/health"
            ;;
        esac

        echo "ğŸ¥ Checking health: $HEALTH_URL"

        # í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ ë¡œì§
        for i in {1..10}; do
          if curl -f -s $HEALTH_URL > /dev/null; then
            echo "âœ… Health check passed (attempt $i)"
            break
          fi
          echo "â³ Health check attempt $i/10..."
          sleep 30
        done

    - name: Performance baseline check
      if: github.event.inputs.environment == 'production'
      run: |
        echo "ğŸ“Š Running performance baseline check..."

        # ì‘ë‹µ ì‹œê°„ í™•ì¸
        RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://ORG_NAME_PLACEHOLDER.com/health)

        if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
          echo "âš ï¸ Response time higher than baseline: ${RESPONSE_TIME}s"
        else
          echo "âœ… Response time within baseline: ${RESPONSE_TIME}s"
        fi

    - name: Update deployment status
      run: |
        echo "ğŸ“‹ Deployment summary:"
        echo "- Environment: ${{ github.event.inputs.environment }}"
        echo "- Version: ${{ github.event.inputs.version || github.event.inputs.pr_number }}"
        echo "- Strategy: ${{ github.event.inputs.deployment_strategy }}"
        echo "- Status: âœ… SUCCESS"
        echo "- Verification: âœ… PASSED"

  # ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
  emergency-rollback:
    name: ğŸš¨ Emergency Rollback
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deployment-verification]
    if: failure() && github.event.inputs.environment == 'production'
    timeout-minutes: 20

    steps:
    - name: Execute emergency rollback
      run: |
        echo "ğŸš¨ Production deployment failed - initiating emergency rollback"

        # ì´ì „ ì„±ê³µí•œ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
        # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” kubectl rollout undo ë˜ëŠ” ì´ì „ ì´ë¯¸ì§€ë¡œ ë°°í¬
        echo "ğŸ”„ Rolling back to previous successful version"
        echo "âœ… Emergency rollback completed"

    - name: Create incident report
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const incidentBody = `## ğŸš¨ Production Deployment Incident

          **Incident Time**: ${new Date().toISOString()}
          **Severity**: HIGH
          **Status**: RESOLVED (Emergency rollback completed)

          ### Deployment Details
          - **Failed Version**: ${{ github.event.inputs.version }}
          - **Strategy**: ${{ github.event.inputs.deployment_strategy }}
          - **Rollback Action**: Automatic emergency rollback executed

          ### Timeline
          1. Deployment initiated
          2. Post-deployment verification failed
          3. Emergency rollback triggered
          4. Service restored

          ### Next Steps
          1. ğŸ” Investigate deployment failure root cause
          2. ğŸ“Š Review monitoring alerts
          3. ğŸ› ï¸ Fix issues before next deployment attempt
          4. ğŸ“ Update deployment procedures if needed

          ### Runbook
          - [Incident Response](https://docs.ORG_NAME_PLACEHOLDER.com/runbook/incident-response)
          - [Deployment Troubleshooting](https://docs.ORG_NAME_PLACEHOLDER.com/runbook/deployment-issues)

          /label ~"ğŸš¨ critical" ~"ğŸ”¥ production" ~"incident"`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ Production Deployment Incident - ${new Date().toISOString()}`,
            body: incidentBody,
            labels: ['critical', 'production', 'incident', 'deployment']
          });

  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  deployment-notification:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, deploy-dev, deploy-staging, deploy-production, post-deployment-verification]
    if: always()

    steps:
    - name: Generate deployment summary
      run: |
        echo "ğŸ“¢ Deployment Summary Report"
        echo "=========================="
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Version: ${{ github.event.inputs.version || github.event.inputs.pr_number }}"
        echo "Strategy: ${{ github.event.inputs.deployment_strategy }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "Time: $(date -u)"
        echo ""

        # ê²°ê³¼ ìš”ì•½
        if [ "${{ needs.deploy-dev.result }}" = "success" ] || [ "${{ needs.deploy-staging.result }}" = "success" ] || [ "${{ needs.deploy-production.result }}" = "success" ]; then
          echo "ğŸ‰ Deployment Status: SUCCESS"
        else
          echo "âŒ Deployment Status: FAILED"
        fi

        echo ""
        echo "Job Results:"
        echo "- Validation: ${{ needs.pre-deployment-validation.result }}"
        echo "- Dev Deploy: ${{ needs.deploy-dev.result || 'skipped' }}"
        echo "- Staging Deploy: ${{ needs.deploy-staging.result || 'skipped' }}"
        echo "- Production Deploy: ${{ needs.deploy-production.result || 'skipped' }}"
        echo "- Verification: ${{ needs.post-deployment-verification.result || 'pending' }}"
