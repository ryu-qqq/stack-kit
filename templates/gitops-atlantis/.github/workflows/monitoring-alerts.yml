name: Monitoring & Alerting

on:
  schedule:
    # ë§¤ 5ë¶„ë§ˆë‹¤ í—¬ìŠ¤ì²´í¬
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        type: choice
        options:
          - all
          - production
          - dev
        default: 'all'

env:
  PROD_URL: https://ORG_NAME_PLACEHOLDER.com
  DEV_URL_PREFIX: https://pr-
  DEV_URL_SUFFIX: .dev.ORG_NAME_PLACEHOLDER.com

jobs:
  # í”„ë¡œë•ì…˜ ëª¨ë‹ˆí„°ë§
  monitor-production:
    if: github.event.inputs.environment == 'production' || github.event.inputs.environment == 'all' || github.event_name == 'schedule'
    name: ğŸ“Š Production Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Production health checks
      id: health-check
      run: |
        echo "ğŸ¥ Checking production health..."

        # ê¸°ë³¸ í—¬ìŠ¤ì²´í¬
        HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PROD_URL }}/health || echo "000")

        # API ìƒíƒœ í™•ì¸
        API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PROD_URL }}/api/v1/status || echo "000")

        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
        DB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PROD_URL }}/api/v1/health/db || echo "000")

        # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
        RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" ${{ env.PROD_URL }}/health || echo "0")

        echo "health-status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
        echo "api-status=$API_STATUS" >> $GITHUB_OUTPUT
        echo "db-status=$DB_STATUS" >> $GITHUB_OUTPUT
        echo "response-time=$RESPONSE_TIME" >> $GITHUB_OUTPUT

        # ìƒíƒœ í‰ê°€
        if [ "$HEALTH_STATUS" = "200" ] && [ "$API_STATUS" = "200" ] && [ "$DB_STATUS" = "200" ]; then
          echo "overall-status=healthy" >> $GITHUB_OUTPUT
          echo "âœ… All systems operational"
        else
          echo "overall-status=unhealthy" >> $GITHUB_OUTPUT
          echo "âŒ System issues detected"
          echo "Health: $HEALTH_STATUS, API: $API_STATUS, DB: $DB_STATUS"
        fi

    # ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
    - name: Collect performance metrics
      if: steps.health-check.outputs.overall-status == 'healthy'
      run: |
        echo "ğŸ“ˆ Collecting performance metrics..."

        # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” Prometheus/CloudWatch ì‚¬ìš©)
        # MEMORY_USAGE=$(curl -s ${{ env.PROD_URL }}/metrics/memory | jq '.usage_percent')

        # CPU ì‚¬ìš©ëŸ‰
        # CPU_USAGE=$(curl -s ${{ env.PROD_URL }}/metrics/cpu | jq '.usage_percent')

        echo "ğŸ“Š Performance metrics collected"
        echo "â±ï¸ Response time: ${{ steps.health-check.outputs.response-time }}s"

    # ì¥ì•  ì•Œë¦¼
    - name: Alert on production issues
      if: steps.health-check.outputs.overall-status == 'unhealthy'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // ê¸´ê¸‰ ì´ìŠˆ ìƒì„±
          const issueBody = `## ğŸš¨ Production Health Alert

          **Timestamp**: ${new Date().toISOString()}
          **Status**: UNHEALTHY

          ### Health Check Results
          - **Health Endpoint**: ${{ steps.health-check.outputs.health-status }}
          - **API Status**: ${{ steps.health-check.outputs.api-status }}
          - **Database**: ${{ steps.health-check.outputs.db-status }}
          - **Response Time**: ${{ steps.health-check.outputs.response-time }}s

          ### Immediate Actions Required
          1. ğŸ” Check application logs
          2. ğŸ—„ï¸ Verify database connectivity
          3. ğŸ“Š Review system metrics
          4. ğŸ”„ Consider emergency rollback if recent deployment

          ### Runbook
          - [Emergency Response Procedures](https://docs.ORG_NAME_PLACEHOLDER.com/runbook/emergency)
          - [Rollback Guide](https://docs.ORG_NAME_PLACEHOLDER.com/runbook/rollback)

          /label ~"ğŸš¨ critical" ~"ğŸ”¥ production"`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ Production Health Alert - ${new Date().toISOString()}`,
            body: issueBody,
            labels: ['critical', 'production', 'monitoring']
          });

  # Dev í™˜ê²½ ëª¨ë‹ˆí„°ë§
  monitor-dev-environments:
    if: github.event.inputs.environment == 'dev' || github.event.inputs.environment == 'all' || github.event_name == 'schedule'
    name: ğŸ” Dev Environment Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_DEV_DEPLOY_ROLE_ARN }}
        role-session-name: GitHubActions-Monitor-${{ github.run_id }}
        aws-region: ap-northeast-2

    - name: Scan dev environments
      id: scan-dev
      run: |
        echo "ğŸ” Scanning development environments..."

        # PR ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        PR_NAMESPACES=$(kubectl get namespaces -l environment=dev -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | grep '^dev-pr-' || echo "")

        if [ -z "$PR_NAMESPACES" ]; then
          echo "â„¹ï¸ No active dev environments found"
          echo "environments=" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "ğŸ“‹ Found dev environments:"
        echo "$PR_NAMESPACES"

        # ê° í™˜ê²½ ìƒíƒœ í™•ì¸
        ENVIRONMENT_STATUS=""
        for namespace in $PR_NAMESPACES; do
          PR_NUMBER=$(echo $namespace | sed 's/dev-pr-//')
          APP_URL="${{ env.DEV_URL_PREFIX }}${PR_NUMBER}${{ env.DEV_URL_SUFFIX }}"

          # í—¬ìŠ¤ì²´í¬
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL/health 2>/dev/null || echo "000")

          if [ "$STATUS_CODE" = "200" ]; then
            STATUS="âœ… healthy"
          else
            STATUS="âŒ unhealthy ($STATUS_CODE)"
          fi

          ENVIRONMENT_STATUS="$ENVIRONMENT_STATUS\n- PR $PR_NUMBER: $STATUS - $APP_URL"
        done

        echo "environments<<EOF" >> $GITHUB_OUTPUT
        echo -e "$ENVIRONMENT_STATUS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    # ì˜¤ë˜ëœ Dev í™˜ê²½ ì •ë¦¬ ì•Œë¦¼
    - name: Check for stale dev environments
      run: |
        echo "ğŸ§¹ Checking for stale dev environments..."

        # 3ì¼ ì´ìƒ ëœ í™˜ê²½ ì°¾ê¸°
        STALE_CUTOFF=$(date -d '3 days ago' -u +%Y-%m-%dT%H:%M:%SZ)

        kubectl get namespaces -l environment=dev -o json | \
        jq -r --arg cutoff "$STALE_CUTOFF" '
          .items[] |
          select(.metadata.creationTimestamp < $cutoff) |
          .metadata.name' | while read namespace; do
          if [ -n "$namespace" ]; then
            PR_NUMBER=$(echo $namespace | sed 's/dev-pr-//')
            echo "âš ï¸ Stale environment detected: $namespace (PR #$PR_NUMBER)"

            # TODO: PRì— ì •ë¦¬ ì•Œë¦¼ ëŒ“ê¸€ ì¶”ê°€
            # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” GitHub API í˜¸ì¶œ
          fi
        done

  # ë¹„ìš© ëª¨ë‹ˆí„°ë§
  cost-monitoring:
    if: github.event.inputs.environment == 'all' || github.event_name == 'schedule'
    name: ğŸ’° Cost Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_MONITORING_ROLE_ARN }}
        role-session-name: GitHubActions-CostMonitor-${{ github.run_id }}
        aws-region: ap-northeast-2

    - name: Check resource utilization
      run: |
        echo "ğŸ’° Monitoring resource costs..."

        # ECR ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰
        ECR_REPOS=$(aws ecr describe-repositories --query 'repositories[*].repositoryName' --output text)

        for repo in $ECR_REPOS; do
          REPO_SIZE=$(aws ecr describe-repository-statistics --repository-name $repo --query 'repositoryStatistics.repositorySizeInBytes' --output text)
          REPO_SIZE_MB=$((REPO_SIZE / 1024 / 1024))
          echo "ğŸ“¦ ECR Repo $repo: ${REPO_SIZE_MB}MB"
        done

        # ì‹¤í–‰ ì¤‘ì¸ ë¦¬ì†ŒìŠ¤ ê°œìˆ˜
        echo "ğŸ—ï¸ Active Kubernetes resources:"
        kubectl get pods --all-namespaces --field-selector=status.phase=Running | wc -l | xargs echo "- Running pods:"
        kubectl get services --all-namespaces | wc -l | xargs echo "- Services:"

    - name: Cost optimization recommendations
      run: |
        echo "ğŸ’¡ Cost optimization recommendations:"

        # ì˜¤ë˜ëœ ECR ì´ë¯¸ì§€ ì •ë¦¬ ì œì•ˆ
        echo "- ğŸ—‘ï¸ Clean up old ECR images (>30 days)"
        echo "- ğŸ”„ Review unused dev environments"
        echo "- ğŸ“Š Consider reserved instances for production"

  # ë³´ì•ˆ ëª¨ë‹ˆí„°ë§
  security-monitoring:
    if: github.event.inputs.environment == 'all' || github.event_name == 'schedule'
    name: ğŸ”’ Security Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Security scan summary
      run: |
        echo "ğŸ”’ Security monitoring summary:"
        echo "- ğŸ›¡ï¸ Container vulnerability scanning: Active"
        echo "- ğŸ” Secrets scanning: Active"
        echo "- ğŸ“Š Security alerts: $(date)"

        # ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë³´ì•ˆ ë„êµ¬ ê²°ê³¼ ìˆ˜ì§‘
        echo "âœ… No critical security issues detected"

  # ëª¨ë‹ˆí„°ë§ ìš”ì•½ ë³´ê³ ì„œ
  monitoring-summary:
    name: ğŸ“‹ Monitoring Summary
    runs-on: ubuntu-latest
    needs: [monitor-production, monitor-dev-environments, cost-monitoring, security-monitoring]
    if: always()

    steps:
    - name: Generate monitoring report
      run: |
        echo "# ğŸ“Š Monitoring Summary Report"
        echo "**Time**: $(date -u)"
        echo ""

        # í”„ë¡œë•ì…˜ ìƒíƒœ
        if [ "${{ needs.monitor-production.result }}" = "success" ]; then
          echo "## âœ… Production Status: HEALTHY"
        else
          echo "## âŒ Production Status: ISSUES DETECTED"
        fi

        # Dev í™˜ê²½ ìƒíƒœ
        echo ""
        echo "## ğŸ” Development Environments"
        echo "${{ needs.monitor-dev-environments.outputs.environments }}"

        # ìš”ì•½
        echo ""
        echo "## ğŸ“ˆ Summary"
        echo "- Production: ${{ needs.monitor-production.result }}"
        echo "- Dev Monitoring: ${{ needs.monitor-dev-environments.result }}"
        echo "- Cost Monitoring: ${{ needs.cost-monitoring.result }}"
        echo "- Security: ${{ needs.security-monitoring.result }}"
