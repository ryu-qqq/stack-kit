# =======================================
# í”„ë¡œì íŠ¸ë³„ Atlantis ì„¤ì •
# ì €ì¥ì†Œ ë£¨íŠ¸ì— ë°°ì¹˜í•  íŒŒì¼
# =======================================

version: 3

# í”„ë¡œì íŠ¸ ì •ì˜
projects:
- name: infrastructure
  dir: .
  
  # ìë™ ê³„íš ì‹¤í–‰
  autoplan:
    when_modified: 
      - "*.tf"
      - "**/*.tf"
      - "*.tfvars"
      - "terraform.tfvars"
    enabled: true
  
  # ì ìš© ì „ í•„ìˆ˜ ìš”êµ¬ì‚¬í•­
  apply_requirements:
    - "approved"        # PR ìŠ¹ì¸ í•„ìˆ˜
    - "mergeable"       # ë¨¸ì§€ ê°€ëŠ¥ ìƒíƒœ
  
  # ê³ ë„í™”ëœ ì›Œí¬í”Œë¡œìš° ì‚¬ìš©
  workflow: infracost-enhanced
  
  # Terraform ì‘ì—… ê³µê°„
  terraform_version: v1.7.5
  
  # ì‚­ì œ ë°©ì§€
  delete_source_branch_on_merge: false

# í™˜ê²½ë³„ í”„ë¡œì íŠ¸ (ì„ íƒì‚¬í•­)
- name: dev-environment
  dir: .
  workspace: dev
  autoplan:
    when_modified: ["*.tf", "**/*.tf"]
    enabled: true
  apply_requirements: ["mergeable"]  # ê°œë°œí™˜ê²½ì€ ìŠ¹ì¸ ë¶ˆìš”
  workflow: infracost-enhanced

- name: staging-environment
  dir: .
  workspace: staging
  autoplan:
    when_modified: ["*.tf", "**/*.tf"]
    enabled: true
  apply_requirements: ["approved", "mergeable"]
  workflow: infracost-enhanced

- name: prod-environment
  dir: .
  workspace: prod
  autoplan:
    when_modified: ["*.tf", "**/*.tf"]
    enabled: false  # í”„ë¡œë•ì…˜ì€ ìˆ˜ë™ ê³„íš
  apply_requirements: 
    - "approved"
    - "mergeable"
  workflow: infracost-enhanced

# ê¸€ë¡œë²Œ ì›Œí¬í”Œë¡œìš° ì •ì˜
workflows:
  infracost-enhanced:
    plan:
      steps:
      # Terraform ê¸°ë³¸ ë‹¨ê³„
      - env:
          name: TF_IN_AUTOMATION
          value: "true"
      - env:
          name: TF_INPUT
          value: "false"
      
      - init
      - plan:
          extra_args: ["-out", "$PLANFILE"]
      
      # ê³ ê¸‰ ë¶„ì„ ë‹¨ê³„
      - run: |
          echo "ğŸ” Terraform ê³„íš ë¶„ì„ ì¤‘..."
          
          # JSON ê³„íš íŒŒì¼ ìƒì„±
          terraform show -json $PLANFILE > $SHOWFILE
          
          # ë¦¬ì†ŒìŠ¤ ë³€ê²½ ì‚¬í•­ ìš”ì•½
          echo "ğŸ“Š ë¦¬ì†ŒìŠ¤ ë³€ê²½ ì‚¬í•­:"
          terraform show -json $PLANFILE | jq -r '
            if .resource_changes then
              .resource_changes | 
              group_by(.change.actions[0]) | 
              map({
                action: .[0].change.actions[0], 
                count: length,
                resources: [.[].address]
              }) |
              .[] | "  \(.action): \(.count)ê°œ ë¦¬ì†ŒìŠ¤"
            else
              "  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            end'
          
          echo "âœ… ê³„íš ë¶„ì„ ì™„ë£Œ"
      
      # Infracost ë¹„ìš© ë¶„ì„
      - run: |
          if [ -n "$INFRACOST_API_KEY" ]; then
            echo "ğŸ’° ë¹„ìš© ë¶„ì„ ì‹œì‘..."
            
            # Infracost ì„¤ì •
            infracost configure set api_key $INFRACOST_API_KEY
            
            # í˜„ì¬ ë¹„ìš© ë¶„ì„
            infracost breakdown \
              --path $SHOWFILE \
              --format table \
              --show-skipped \
              | tee current_cost.txt
            
            # ë² ì´ìŠ¤ë¼ì¸ê³¼ ë¹„êµ (ìˆëŠ” ê²½ìš°)
            if [ -f "infracost-base.json" ]; then
              echo "ğŸ“ˆ ë¹„ìš© ë³€ê²½ì‚¬í•­ ë¶„ì„..."
              infracost diff \
                --path $SHOWFILE \
                --compare-to infracost-base.json \
                --format table \
                | tee cost_diff.txt
            fi
            
            # GitHub ëŒ“ê¸€ ì‘ì„±
            infracost comment github \
              --path $SHOWFILE \
              --repo "$BASE_REPO_OWNER/$BASE_REPO_NAME" \
              --pull-request $PULL_NUM \
              --github-token $ATLANTIS_GH_TOKEN \
              --behavior update 2>/dev/null || echo "ğŸ’¬ ë¹„ìš© ëŒ“ê¸€ ì‘ì„± ê±´ë„ˆë›°ê¸°"
            
            echo "âœ… ë¹„ìš© ë¶„ì„ ì™„ë£Œ"
          else
            echo "âš ï¸ Infracost API í‚¤ ì—†ìŒ - ë¹„ìš© ë¶„ì„ ê±´ë„ˆë›°ê¸°"
          fi
      
      # ë³´ì•ˆ ê²€ì‚¬ (ê°„ë‹¨í•œ ë²„ì „)
      - run: |
          echo "ğŸ” ê¸°ë³¸ ë³´ì•ˆ ê²€ì‚¬..."
          
          # ê¸°ë³¸ ë³´ì•ˆ íŒ¨í„´ ê²€ì‚¬
          if grep -r "password\|secret\|key" *.tf *.tfvars 2>/dev/null | grep -v "variable\|description\|arn"; then
            echo "âš ï¸ í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê°€ëŠ¥ì„± ë°œê²¬"
          fi
          
          echo "âœ… ê¸°ë³¸ ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"
      
      # AI ë¦¬ë·° ì‹œìŠ¤í…œ ì—°ë™
      - run: |
          echo "ğŸ¤– AI ê³„íš ë¦¬ë·° ì‹œì‘..."
          
          # AI ë¦¬ë·°ìš© S3 ë²„í‚·ì´ ì„¤ì •ëœ ê²½ìš°ë§Œ ì‹¤í–‰
          if [ -n "$AI_REVIEW_BUCKET" ]; then
            # ë¦¬ë·°ìš© ë©”íƒ€ë°ì´í„° ìƒì„±
            cat > review_metadata.json << EOF
          {
            "pull_request": {
              "number": $PULL_NUM,
              "title": "$PULL_TITLE",
              "base_branch": "$BASE_BRANCH_NAME",
              "head_branch": "$HEAD_BRANCH_NAME",
              "author": "$PULL_AUTHOR"
            },
            "repository": {
              "owner": "$BASE_REPO_OWNER", 
              "name": "$BASE_REPO_NAME",
              "full_name": "$BASE_REPO_FULL_NAME"
            },
            "terraform": {
              "version": "$(terraform version -json | jq -r .terraform_version)",
              "workspace": "$WORKSPACE",
              "project": "$PROJECT_NAME"
            },
            "analysis": {
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "plan_file": "$PLANFILE",
              "show_file": "$SHOWFILE"
            }
          }
          EOF
          
            # S3ì— ê³„íš íŒŒì¼ ì—…ë¡œë“œ (AI ë¦¬ë·° íŠ¸ë¦¬ê±°)
            REVIEW_KEY="terraform-plans/$BASE_REPO_OWNER-$BASE_REPO_NAME/pr-$PULL_NUM/$(date +%Y%m%d-%H%M%S).json"
            
            # ë¦¬ë·° íŒ¨í‚¤ì§€ ìƒì„±
            jq -n \
              --argjson metadata "$(cat review_metadata.json)" \
              --argjson plan "$(cat $SHOWFILE)" \
              '{
                metadata: $metadata,
                terraform_plan: $plan,
                review_request_id: ($metadata.pull_request.number | tostring) + "-" + ($metadata.analysis.timestamp)
              }' > ai_review_package.json
            
            # S3 ì—…ë¡œë“œ (Lambda íŠ¸ë¦¬ê±°)
            aws s3 cp ai_review_package.json "s3://$AI_REVIEW_BUCKET/$REVIEW_KEY" \
              --metadata "pr-number=$PULL_NUM,repo=$BASE_REPO_FULL_NAME,timestamp=$(date +%s)" \
              2>/dev/null || echo "âš ï¸ AI ë¦¬ë·° ì—…ë¡œë“œ ì‹¤íŒ¨ - ë¦¬ë·° ê±´ë„ˆë›°ê¸°"
            
            echo "ğŸ“¤ AI ë¦¬ë·° ìš”ì²­ ì „ì†¡: s3://$AI_REVIEW_BUCKET/$REVIEW_KEY"
            echo "ğŸ¤– AI ë¦¬ë·°ê°€ ë³„ë„ë¡œ PRì— ëŒ“ê¸€ë¡œ ì œê³µë©ë‹ˆë‹¤"
            
          else
            echo "â„¹ï¸ AI_REVIEW_BUCKET ì„¤ì • ì—†ìŒ - AI ë¦¬ë·° ê±´ë„ˆë›°ê¸°"
          fi
          
          echo "âœ… AI ë¦¬ë·° ì—°ë™ ì™„ë£Œ"

    apply:
      steps:
      - apply
      
      # ì ìš© í›„ ì²˜ë¦¬
      - run: |
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          echo "â° ì™„ë£Œ ì‹œê°„: $(date)"
          
          # ë¹„ìš© ë² ì´ìŠ¤ë¼ì¸ ì—…ë°ì´íŠ¸
          if [ -f "$SHOWFILE" ] && [ -n "$INFRACOST_API_KEY" ]; then
            echo "ğŸ“Š ë¹„ìš© ë² ì´ìŠ¤ë¼ì¸ ì—…ë°ì´íŠ¸..."
            cp $SHOWFILE infracost-base.json
            
            # ìµœì¢… ë¹„ìš© ì •ë³´
            infracost breakdown --path $SHOWFILE --format json > final-cost.json
            MONTHLY_COST=$(cat final-cost.json | jq -r '.totalMonthlyCost // "ì•Œ ìˆ˜ ì—†ìŒ"')
            echo "ğŸ’° ì›”ê°„ ì˜ˆìƒ ë¹„ìš©: ${MONTHLY_COST} USD"
          fi
          
          echo "âœ… í›„ì²˜ë¦¬ ì‘ì—… ì™„ë£Œ"

# Atlantis ì„œë²„ ì„¤ì •
automerge: false
delete_source_branch_on_merge: false
parallel_plan: 2
parallel_apply: 1