# StackKit Atlantis + AI Reviewer ìžë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
name: ðŸ—ï¸ Deploy Atlantis Infrastructure

permissions:
  id-token: write   # OIDC í† í° ë°œê¸‰ì„ ìœ„í•´ í•„ìš”
  contents: read    # ì €ìž¥ì†Œ ë‚´ìš© ì½ê¸° ê¶Œí•œ

on:
  push:
    branches: [main]
    paths: 
      - 'config/**'
      - 'terraform/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - destroy
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

env:
  TF_VERSION: "1.8.5"
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-northeast-2' }}

jobs:
  validate-config:
    runs-on: ubuntu-latest
    outputs:
      org-name: ${{ steps.config.outputs.org-name }}
      environment: ${{ steps.config.outputs.environment }}
      has-secrets: ${{ steps.config.outputs.has-secrets }}
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ“‹ Validate Configuration
      id: config
      run: |
        # config.yml íŒŒì¼ì—ì„œ ì„¤ì • ì½ê¸°
        if [[ ! -f "config/config.yml" ]]; then
          echo "âŒ config/config.yml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          echo "ì„¤ì • ê°€ì´ë“œ: https://github.com/your-org/stackkit-template#setup"
          exit 1
        fi
        
        # yqë¥¼ ì‚¬ìš©í•œ ì„¤ì • íŒŒì‹±
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq
        
        ORG_NAME=$(yq '.organization.name' config/config.yml)
        ENVIRONMENT=$(yq '.environment.name' config/config.yml)
        
        echo "org-name=$ORG_NAME" >> $GITHUB_OUTPUT
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        
        # í•„ìˆ˜ ì‹œí¬ë¦¿ í™•ì¸ (OIDC ì‚¬ìš©)
        REQUIRED_SECRETS=("OPENAI_API_KEY" "SLACK_WEBHOOK_URL" "AWS_OIDC_ROLE_ARN")
        HAS_SECRETS=true
        
        # GitHub SecretsëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„¤ì • ê°€ì´ë“œë§Œ ì¶œë ¥
        echo "ðŸ” í•„ìˆ˜ GitHub Secrets í™•ì¸:"
        echo "- OPENAI_API_KEY: OpenAI API í‚¤"
        echo "- SLACK_WEBHOOK_URL: Slack ì›¹í›… URL"
        echo "- AWS_OIDC_ROLE_ARN: AWS OIDC IAM ì—­í•  ARN"
        echo "- GITHUB_TOKEN: GitHub Personal Access Token (Atlantisìš©)"
        
        # ì‹¤ì œ ê²€ì¦ì€ workflow ì‹¤í–‰ ì‹œ í™•ì¸ë¨
        echo "has-secrets=true" >> $GITHUB_OUTPUT

  build-ai-reviewer:
    runs-on: ubuntu-latest
    needs: validate-config
    steps:
    - uses: actions/checkout@v4
    
    - name: â˜• Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'corretto'
        java-version: '21'
    
    - name: ðŸ”§ Build AI Reviewer Lambda
      run: |
        cd ai-reviewer
        ./gradlew clean build
        
        # Lambda íŒ¨í‚¤ì§€ë¥¼ Terraformì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìžˆë„ë¡ ë³µì‚¬
        mkdir -p ../terraform/lambda-packages
        cp build/libs/atlantis-ai-reviewer-*.jar ../terraform/lambda-packages/
        
        echo "ðŸŽ‰ AI Reviewer Lambda ë¹Œë“œ ì™„ë£Œ"
    
    - name: ðŸ“¦ Upload Lambda Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ai-reviewer-lambda
        path: terraform/lambda-packages/
        retention-days: 7

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: [validate-config, build-ai-reviewer]
    if: needs.validate-config.outputs.has-secrets == 'true'
    environment: ${{ needs.validate-config.outputs.environment }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ“¦ Download Lambda Artifact
      uses: actions/download-artifact@v4
      with:
        name: ai-reviewer-lambda
        path: terraform/lambda-packages/
    
    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: â˜ï¸ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
        role-session-name: GitHubActions-StackKit-Atlantis
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ðŸ—ï¸ Initialize Terraform
      run: |
        cd terraform/environments/${{ needs.validate-config.outputs.environment }}
        
        # ë°±ì—”ë“œ ì„¤ì • ìƒì„±
        cat > backend.tf << EOF
        terraform {
          backend "s3" {
            bucket = "${{ needs.validate-config.outputs.org-name }}-atlantis-terraform-state"
            key    = "atlantis-${{ needs.validate-config.outputs.environment }}.tfstate"
            region = "${{ env.AWS_REGION }}"
            
            dynamodb_table = "${{ needs.validate-config.outputs.org-name }}-atlantis-terraform-locks"
            encrypt        = true
          }
        }
        EOF
        
        # S3 ë²„í‚·ê³¼ DynamoDB í…Œì´ë¸” ìƒì„± (ì—†ëŠ” ê²½ìš°)
        aws s3 mb s3://${{ needs.validate-config.outputs.org-name }}-atlantis-terraform-state --region ${{ env.AWS_REGION }} || true
        aws dynamodb create-table \
          --table-name ${{ needs.validate-config.outputs.org-name }}-atlantis-terraform-locks \
          --attribute-definitions AttributeName=LockID,AttributeType=S \
          --key-schema AttributeName=LockID,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST \
          --region ${{ env.AWS_REGION }} || true
        
        terraform init
    
    - name: ðŸ“‹ Terraform Plan
      run: |
        cd terraform/environments/${{ needs.validate-config.outputs.environment }}
        
        # í™˜ê²½ ë³€ìˆ˜ë¥¼ Terraform ë³€ìˆ˜ë¡œ ì „ë‹¬
        export TF_VAR_github_token="${{ secrets.GITHUB_TOKEN }}"
        export TF_VAR_openai_api_key="${{ secrets.OPENAI_API_KEY }}"
        export TF_VAR_slack_webhook_url="${{ secrets.SLACK_WEBHOOK_URL }}"
        export TF_VAR_org_name="${{ needs.validate-config.outputs.org-name }}"
        export TF_VAR_environment="${{ needs.validate-config.outputs.environment }}"
        
        terraform plan -out=tfplan
        
        # Plan ìš”ì•½ì„ PR ì½”ë©˜íŠ¸ë¡œ ì¶œë ¥
        terraform show -json tfplan > plan.json
        
        echo "## ðŸ—ï¸ Terraform Plan ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        terraform show tfplan | head -50 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸš€ Terraform Apply
      if: github.event_name != 'pull_request'
      run: |
        cd terraform/environments/${{ needs.validate-config.outputs.environment }}
        
        export TF_VAR_github_token="${{ secrets.GITHUB_TOKEN }}"
        export TF_VAR_openai_api_key="${{ secrets.OPENAI_API_KEY }}"
        export TF_VAR_slack_webhook_url="${{ secrets.SLACK_WEBHOOK_URL }}"
        export TF_VAR_org_name="${{ needs.validate-config.outputs.org-name }}"
        export TF_VAR_environment="${{ needs.validate-config.outputs.environment }}"
        
        terraform apply tfplan
        
        # ì¶œë ¥ê°’ì„ ì €ìž¥í•˜ì—¬ ë‚˜ì¤‘ì— ì‚¬ìš©
        terraform output -json > outputs.json
        
        echo "## âœ… ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— ì ‘ì† ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **Atlantis URL**: $(terraform output -raw atlantis_url)" >> $GITHUB_STEP_SUMMARY
        echo "- **S3 Bucket**: $(terraform output -raw s3_bucket_name)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
        echo "1. GitHub Webhook ì„¤ì •: $(terraform output -raw atlantis_url)/events" >> $GITHUB_STEP_SUMMARY
        echo "2. í”„ë¡œì íŠ¸ ë ˆí¬ì— \`atlantis.yaml\` ì¶”ê°€" >> $GITHUB_STEP_SUMMARY
        echo "3. PR ìƒì„±í•˜ì—¬ AI ë¦¬ë·° í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ“¤ Upload Terraform Outputs
      uses: actions/upload-artifact@v4
      with:
        name: terraform-outputs
        path: terraform/environments/${{ needs.validate-config.outputs.environment }}/outputs.json
        retention-days: 30

  setup-github-webhooks:
    runs-on: ubuntu-latest
    needs: [validate-config, deploy-infrastructure]
    if: success() && github.event_name != 'pull_request'
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ“¦ Download Terraform Outputs
      uses: actions/download-artifact@v4
      with:
        name: terraform-outputs
        path: ./
    
    - name: ðŸ”— Setup GitHub Webhook
      run: |
        # Terraform ì¶œë ¥ì—ì„œ Atlantis URL ì¶”ì¶œ
        ATLANTIS_URL=$(jq -r '.atlantis_url.value' outputs.json)
        WEBHOOK_SECRET=$(jq -r '.webhook_secret.value' outputs.json)
        
        # GitHub Webhook ìžë™ ì„¤ì •
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/hooks \
          -d '{
            "name": "web",
            "active": true,
            "events": ["push", "pull_request", "issue_comment", "pull_request_review"],
            "config": {
              "url": "'$ATLANTIS_URL'/events",
              "content_type": "json",
              "secret": "'$WEBHOOK_SECRET'"
            }
          }'
        
        echo "âœ… GitHub Webhookì´ ìžë™ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY

  notify-completion:
    runs-on: ubuntu-latest
    needs: [validate-config, deploy-infrastructure, setup-github-webhooks]
    if: always()
    steps:
    - name: ðŸŽ‰ Deployment Notification
      run: |
        if [[ "${{ needs.deploy-infrastructure.result }}" == "success" ]]; then
          echo "## ðŸŽ‰ StackKit Atlantis ë°°í¬ ì™„ë£Œ!"
          echo ""
          echo "### ðŸš€ ë°°í¬ëœ ì»´í¬ë„ŒíŠ¸"
          echo "- âœ… Atlantis ECS ì„œë¹„ìŠ¤"
          echo "- âœ… AI Reviewer Lambda í•¨ìˆ˜"
          echo "- âœ… S3 ë²„í‚· (Plan/Apply ì €ìž¥)"
          echo "- âœ… SQS í (ì´ë²¤íŠ¸ ì²˜ë¦¬)"
          echo "- âœ… GitHub Webhook ì—°ë™"
          echo ""
          echo "### ðŸ“‹ ì‚¬ìš©ë²•"
          echo "1. ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ Terraform ì½”ë“œ ìž‘ì„±"
          echo "2. PR ìƒì„±í•˜ë©´ ìžë™ìœ¼ë¡œ AI ë¦¬ë·° ì‹œìž‘"
          echo "3. ìŠ¹ì¸ í›„ \`atlantis apply\` ì½”ë©˜íŠ¸ë¡œ ë°°í¬"
        else
          echo "## âŒ ë°°í¬ ì‹¤íŒ¨"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
        fi >> $GITHUB_STEP_SUMMARY