#!/usr/bin/env bash
set -euo pipefail

# StackKit ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ - ê¸°ì¡´ í”„ë¡œì íŠ¸ì— StackKit ëª¨ë“ˆ ì„¤ì¹˜
# ì‚¬ìš©ë²•: curl -sSL https://raw.githubusercontent.com/your-org/stackkit/main/scripts/stackkit-init.sh | bash

SCRIPT_NAME="StackKit Initializer"
STACKKIT_REPO="https://github.com/your-org/stackkit.git"
TEMP_DIR="/tmp/stackkit-$$"
TARGET_DIR="${1:-$(pwd)}"

echo "ðŸš€ $SCRIPT_NAME"
echo "================================="
echo "Target Directory: $TARGET_DIR"
echo ""

# Step 1: ëŒ€ìƒ ë””ë ‰í† ë¦¬ í™•ì¸
if [[ ! -d "$TARGET_DIR" ]]; then
    echo "âŒ Target directory does not exist: $TARGET_DIR"
    exit 1
fi

cd "$TARGET_DIR"

# ê¸°ì¡´ í”„ë¡œì íŠ¸ í™•ì¸
if [[ ! -f "pom.xml" && ! -f "build.gradle" && ! -f "package.json" && ! -f "requirements.txt" ]]; then
    echo "âš ï¸  No project files detected. Are you in the right directory?"
    echo "   Expected: pom.xml, build.gradle, package.json, or requirements.txt"
    read -p "   Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Step 2: StackKit ë‹¤ìš´ë¡œë“œ
echo "ðŸ“¥ Downloading StackKit modules..."
git clone --depth 1 "$STACKKIT_REPO" "$TEMP_DIR" > /dev/null 2>&1

# Step 3: í•„ìš”í•œ íŒŒì¼ë“¤ë§Œ ë³µì‚¬
echo "ðŸ“‹ Installing StackKit components..."

# Terraform ëª¨ë“ˆ ë³µì‚¬
if [[ ! -d "terraform" ]]; then
    mkdir -p terraform
fi

cp -r "$TEMP_DIR/terraform/modules" terraform/
cp -r "$TEMP_DIR/terraform/scripts" terraform/
cp "$TEMP_DIR/terraform/docs/IMPORT_GUIDE.md" terraform/

# AI ReviewerëŠ” ë³„ë„ ì„¤ì¹˜ ì•ˆë‚´ë§Œ ì œê³µ
echo "ðŸ¤– AI ReviewerëŠ” ë³„ë„ë¡œ êµ¬ì¶•í•˜ì„¸ìš”:"
echo "   1. StackKit ì €ìž¥ì†Œë¥¼ í´ë¡ í•˜ì—¬ AI ë¦¬ë·°ì–´ êµ¬ì¶•"
echo "   2. êµ¬ì¶•ëœ AI ë¦¬ë·°ì–´ê°€ ì—¬ëŸ¬ í”„ë¡œì íŠ¸ë¥¼ ë¦¬ë·°"
echo "   â„¹ï¸  ìžì„¸í•œ ë‚´ìš©: https://github.com/your-org/stackkit#ai-reviewer"

# Atlantis ì„¤ì • ë³µì‚¬
cp -r "$TEMP_DIR/atlantis" .

# ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
if [[ ! -d "scripts" ]]; then
    mkdir -p scripts
fi
cp "$TEMP_DIR/scripts/setup-atlantis-ai.sh" scripts/
cp "$TEMP_DIR/scripts/integrate-existing-project.sh" scripts/

# Step 4: í”„ë¡œì íŠ¸ë³„ ì„¤ì • ìƒì„±
echo "âš™ï¸  Generating project configuration..."

PROJECT_NAME=$(basename "$TARGET_DIR")
cat > "terraform.tfvars" << EOF
# StackKit Configuration for $PROJECT_NAME
# Generated by stackkit-init.sh on $(date)

project_name = "$PROJECT_NAME"
environment  = "dev"
region      = "ap-northeast-2"

# Customize these values for your project
# vpc_cidr = "10.0.0.0/16"
# availability_zones = ["ap-northeast-2a", "ap-northeast-2c"]

# OpenAI API Key (for AI Reviewer)
# openai_api_key = "your-openai-api-key"

# GitHub Integration
# github_token = "your-github-token"
# github_webhook_secret = "your-webhook-secret"
EOF

# Step 5: README ìƒì„±
cat > "STACKKIT_README.md" << 'EOF'
# StackKit Integration

This project now includes StackKit modules for AWS infrastructure management.

## ðŸš€ Quick Start

### 1. Setup Atlantis AI Reviewer
```bash
./scripts/setup-atlantis-ai.sh
```

### 2. Deploy Infrastructure
```bash
cd terraform
terraform init
terraform plan
terraform apply
```

### 3. Configure GitHub Webhook
Follow the instructions in the setup script output.

## ðŸ“ Directory Structure

```
your-project/
â”œâ”€â”€ src/                    # Your application code
â”œâ”€â”€ terraform/              # StackKit Terraform modules
â”‚   â”œâ”€â”€ modules/           # Reusable infrastructure modules
â”‚   â””â”€â”€ scripts/           # Deployment scripts
â”œâ”€â”€ ai-reviewer/           # AI code reviewer (optional)
â”œâ”€â”€ atlantis/              # Atlantis configuration
â””â”€â”€ scripts/               # Setup scripts
```

## ðŸ“š Documentation

- [StackKit Modules](terraform/modules/README.md)
- [Import Guide](terraform/IMPORT_GUIDE.md)
- [AI Reviewer Setup](ai-reviewer/README.md)

## ðŸ†˜ Support

- GitHub Issues: https://github.com/your-org/stackkit/issues
- Documentation: https://github.com/your-org/stackkit
EOF

# Step 6: .gitignore ì—…ë°ì´íŠ¸
if [[ -f ".gitignore" ]]; then
    echo "" >> .gitignore
    echo "# StackKit" >> .gitignore
    echo ".terraform/" >> .gitignore
    echo "*.tfstate" >> .gitignore
    echo "*.tfstate.backup" >> .gitignore
    echo ".terraform.lock.hcl" >> .gitignore
else
    cat > .gitignore << 'EOF'
# StackKit
.terraform/
*.tfstate
*.tfstate.backup
.terraform.lock.hcl

# Secrets
terraform.tfvars.backup
*.pem
*.key
EOF
fi

# Step 7: ì •ë¦¬
rm -rf "$TEMP_DIR"

echo ""
echo "ðŸŽ‰ StackKit installation complete!"
echo "=================================="
echo ""
echo "ðŸ“‹ What was installed:"
echo "   âœ… Terraform modules (terraform/modules/)"
echo "   âœ… Deployment scripts (scripts/)"
echo "   âœ… Atlantis configuration (atlantis/)"
echo "   âœ… Project configuration (terraform.tfvars)"
echo "   âœ… Documentation (STACKKIT_README.md)"
echo ""
echo "ðŸ“‹ Next steps:"
echo "1. ðŸ”§ Edit terraform.tfvars with your settings"
echo "2. ðŸš€ Run: ./scripts/setup-atlantis-ai.sh"
echo "3. ðŸ“– Read: STACKKIT_README.md"
echo ""
echo "ðŸ’¡ Your project structure:"
echo "   - Keep your application code in src/ (or existing structure)"
echo "   - Use terraform/ for infrastructure"
echo "   - StackKit modules are now part of YOUR project"
echo ""
echo "ðŸ†˜ Need help? Check STACKKIT_README.md or visit:"
echo "   https://github.com/your-org/stackkit"
