# Server-side repository configuration for Atlantis
# This file configures Atlantis behavior for all repositories

repos:
  # Default configuration for all stackkit repositories
  - id: github.com/your-org/stackkit-*
    # Allow these repositories to use Atlantis
    allowed_overrides: [workflow]

    # Custom workflow with AI reviews
    workflow: stackkit-ai-review

    # Plan settings
    plan_requirements: []

    # Apply requirements - require approval and mergeable PR
    apply_requirements: [approved, mergeable]

    # Import requirements (optional)
    import_requirements: [approved]

    # Allow parallel plans but not applies
    parallel_plan: true
    parallel_apply: false

    # Delete Atlantis plans after merge
    delete_source_branch_on_merge: true

    # Repository locking
    repo_locking: true

  # Specific configuration for infrastructure repositories
  - id: github.com/your-org/*-infrastructure
    workflow: stackkit-ai-review
    apply_requirements: [approved, mergeable]

    # Additional security for infrastructure repos
    plan_requirements: [approved]

    # Custom pre/post hooks for infrastructure
    pre_workflow_hooks:
      - run: |
          echo "üèóÔ∏è  Infrastructure deployment starting"
          echo "Environment: ${ATLANTIS_REPO_NAME##*-}"
          
          # Validate terraform version
          terraform version
          
          # Security scan (optional)
          # checkov -f . --framework terraform

    post_workflow_hooks:
      - run: |
          echo "üéâ Infrastructure deployment completed"
          echo "Check Slack for AI-powered review results"

  # Development environment - more relaxed settings
  - id: github.com/your-org/*-dev
    workflow: stackkit-ai-review
    apply_requirements: [mergeable]  # No approval required for dev
    parallel_apply: true  # Allow parallel applies in dev
    delete_source_branch_on_merge: false

  # Production environment - strict settings
  - id: github.com/your-org/*-prod
    workflow: stackkit-ai-review
    apply_requirements: [approved, mergeable]
    plan_requirements: [approved]  # Require approval even for plans
    parallel_apply: false
    repo_locking: true

    # Additional validation for production
    pre_workflow_hooks:
      - run: |
          echo "üö® PRODUCTION DEPLOYMENT"
          echo "Extra validation checks running..."
          
          # Require specific branch patterns
          if [[ ! "$ATLANTIS_REPO_NAME" =~ -prod$ ]]; then
            echo "‚ùå Production deployments must use repositories ending in '-prod'"
            exit 1
          fi
          
          # Check for required tags/labels (customize as needed)
          echo "‚úÖ Production validation passed"