version: 3

# ì—¬ëŸ¬ í”„ë¡œì íŠ¸ë¥¼ ë³‘ë ¬ë¡œ í”Œëžœ/ì ìš© ê°€ëŠ¥
parallel_plan: true
parallel_apply: true

# === í”„ë¡œì íŠ¸ ëª©ë¡ ===
projects:
  # ì˜ˆì‹œ 1) shared/prod ìŠ¤íƒ
  - name: shared-prod
    dir: terraform/stacks/shared/prod
    workflow: stackkit-prod
    autoplan:
      enabled: true
      when_modified: ["**/*.tf", "**/*.tfvars", "../../../modules/**"]
    terraform_version: v1.8.5

  # ì˜ˆì‹œ 2) messaging/dev ìŠ¤íƒ
  - name: messaging-dev
    dir: terraform/stacks/messaging/dev
    workflow: stackkit-dev
    autoplan:
      enabled: true
      when_modified: ["**/*.tf", "**/*.tfvars", "../../../modules/**"]
    terraform_version: v1.8.5

  # atlantis-ai-reviewer/dev ìŠ¤íƒ
  - name: atlantis-ai-reviewer-dev
    dir: terraform/stacks/atlantis-ai-reviewer/dev
    workflow: stackkit-dev
    autoplan:
      enabled: true
      when_modified: ["**/*.tf", "**/*.tfvars", "../../../modules/**"]
    terraform_version: v1.8.5

# === ê³µí†µ/í™˜ê²½ë³„ ì›Œí¬í”Œë¡œ ===
workflows:
  # dev í™˜ê²½: -var-file dev.tfvars
  stackkit-dev:
    plan:
      steps:
        - init
        - plan:
            # ë‚´ìž¥ plan + -var-file ì¶”ê°€ (ë‚´ìž¥ planì€ ìžë™ìœ¼ë¡œ -out $PLANFILEì„ ì‚¬ìš©)
            extra_args: ["-input=false", "-var-file", "dev.tfvars"]
        - run: |
            set -euo pipefail
            # 1) í”Œëžœì„ JSON/í…ìŠ¤íŠ¸ë¡œ ë¤í”„
            terraform show -json "$PLANFILE" > tfplan.json
            terraform show "$PLANFILE" > plan.txt
            
            # 2) Infracost ë¹„ìš© ì¶”ì • ì‹¤í–‰
            echo "ðŸ’° Infracost ë¹„ìš© ì¶”ì • ì‹¤í–‰ ì¤‘..."
            if command -v infracost &> /dev/null; then
                # Infracost ì„¤ì • í™•ì¸
                if [[ -z "${INFRACOST_API_KEY:-}" ]]; then
                    echo "âš ï¸  INFRACOST_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ. ë¹„ìš© ì¶”ì • ê±´ë„ˆë›°ê¸°."
                    echo '{"totalMonthlyCost":"0","currency":"USD","projects":[]}' > infracost.json
                else
                    # Infracost ì‹¤í–‰
                    infracost breakdown \
                        --path . \
                        --format json \
                        --out-file infracost.json \
                        --terraform-plan-path "$PLANFILE" || {
                        echo "âš ï¸  Infracost ì‹¤í–‰ ì‹¤íŒ¨. ê¸°ë³¸ ë¹„ìš© ë°ì´í„° ìƒì„±."
                        echo '{"totalMonthlyCost":"0","currency":"USD","projects":[]}' > infracost.json
                    }
                    
                    # ì‚¬ëžŒì´ ì½ê¸° ì‰¬ìš´ í˜•íƒœë¡œë„ ìƒì„±
                    infracost breakdown \
                        --path . \
                        --format table \
                        --terraform-plan-path "$PLANFILE" > infracost.txt 2>/dev/null || {
                        echo "ë¹„ìš© ì¶”ì • ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." > infracost.txt
                    }
                fi
            else
                echo "âš ï¸  Infracostê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ. ê¸°ë³¸ ë¹„ìš© ë°ì´í„° ìƒì„±."
                echo '{"totalMonthlyCost":"0","currency":"USD","projects":[]}' > infracost.json
                echo "Infracostê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•„ ë¹„ìš© ì¶”ì •ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." > infracost.txt
            fi
            
            # 3) ì—…ë¡œë“œ ê²½ë¡œ êµ¬ì„±
            BUCKET="${PLAN_BUCKET:-plan-artifacts}"
            PREFIX="atlantis/${BASE_REPO_OWNER}/${BASE_REPO_NAME}/${PULL_NUM}/${PROJECT_NAME:-$(basename "$REPO_REL_DIR" | tr '/' '-')}"
            
            # 4) ë³€ê²½ ìœ ë¬´(ë¦¬ì†ŒìŠ¤ ë³€í™” ì—¬ë¶€) ê³„ì‚°
            HAS_CHANGES=$(jq '(.resource_changes|length) > 0' tfplan.json)
            
            # 5) ë¹„ìš© ì •ë³´ ì¶”ì¶œ
            MONTHLY_COST=$(jq -r '.totalMonthlyCost // "0"' infracost.json 2>/dev/null || echo "0")
            
            # 6) ë©”íƒ€(manifest) ìƒì„± (ë¹„ìš© ì •ë³´ í¬í•¨)
            jq -n --arg repo "${BASE_REPO_OWNER}/${BASE_REPO_NAME}" \
                  --arg pr "$PULL_NUM" \
                  --arg proj "$PROJECT_NAME" \
                  --arg action "plan" \
                  --arg status "success" \
                  --arg commit "$HEAD_COMMIT" \
                  --arg cost "$MONTHLY_COST" \
                  --argjson has "$HAS_CHANGES" \
                  '{repo:$repo,pr:($pr|tonumber),project:$proj,action:$action,status:$status,commit:$commit,has_changes:$has,monthly_cost:$cost}' \
              > manifest.json
            
            # 7) S3 ì—…ë¡œë“œ (Infracost ê²°ê³¼ í¬í•¨)
            aws s3 cp "$PLANFILE"      "s3://$BUCKET/$PREFIX/tfplan.bin"
            aws s3 cp tfplan.json      "s3://$BUCKET/$PREFIX/tfplan.json"
            aws s3 cp plan.txt         "s3://$BUCKET/$PREFIX/plan.txt"
            aws s3 cp infracost.json   "s3://$BUCKET/$PREFIX/infracost.json"
            aws s3 cp infracost.txt    "s3://$BUCKET/$PREFIX/infracost.txt"
            aws s3 cp manifest.json    "s3://$BUCKET/$PREFIX/manifest.json"
            
            echo "ðŸ“¤ Plan ê²°ê³¼ ë° ë¹„ìš© ì¶”ì •ì´ AI ë¦¬ë·°ë¥¼ ìœ„í•´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "ðŸ’° ì˜ˆìƒ ì›”ê°„ ë¹„ìš©: $MONTHLY_COST USD"
    apply:
      steps:
        # ë‚´ìž¥ apply ëŒ€ì‹  ì»¤ìŠ¤í…€ ì‹¤í–‰(ë¡œê·¸ íŒŒì¼ ë³´ì¡´)
        - run: |
            set +e
            terraform apply -input=false -no-color "$PLANFILE" | tee apply.txt
            STATUS=$?
            set -e
            BUCKET="${PLAN_BUCKET:-plan-artifacts}"
            PREFIX="atlantis/${BASE_REPO_OWNER}/${BASE_REPO_NAME}/${PULL_NUM}/${PROJECT_NAME:-$(basename "$REPO_REL_DIR" | tr '/' '-')}"
            jq -n --arg repo "${BASE_REPO_OWNER}/${BASE_REPO_NAME}" \
                  --arg pr "$PULL_NUM" \
                  --arg proj "$PROJECT_NAME" \
                  --arg action "apply" \
                  --arg status "$([ $STATUS -eq 0 ] && echo success || echo failure)" \
                  --arg commit "$HEAD_COMMIT" \
                  '{repo:$repo,pr:($pr|tonumber),project:$proj,action:$action,status:$status,commit:$commit}' \
              > manifest.json
            aws s3 cp apply.txt      "s3://$BUCKET/$PREFIX/apply.txt"
            aws s3 cp manifest.json  "s3://$BUCKET/$PREFIX/manifest.json"
            exit $STATUS

  # prod í™˜ê²½: -var-file prod.tfvars
  stackkit-prod:
    plan:
      steps:
        - init
        - plan:
            extra_args: ["-input=false", "-var-file", "prod.tfvars"]
        - run: |
            set -euo pipefail
            # 1) í”Œëžœì„ JSON/í…ìŠ¤íŠ¸ë¡œ ë¤í”„
            terraform show -json "$PLANFILE" > tfplan.json
            terraform show "$PLANFILE" > plan.txt
            
            # 2) Infracost ë¹„ìš© ì¶”ì • ì‹¤í–‰ (prod í™˜ê²½ìš©)
            echo "ðŸ’° Infracost ë¹„ìš© ì¶”ì • ì‹¤í–‰ ì¤‘..."
            if command -v infracost &> /dev/null; then
                if [[ -z "${INFRACOST_API_KEY:-}" ]]; then
                    echo "âš ï¸  INFRACOST_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ. ë¹„ìš© ì¶”ì • ê±´ë„ˆë›°ê¸°."
                    echo '{"totalMonthlyCost":"0","currency":"USD","projects":[]}' > infracost.json
                else
                    infracost breakdown \
                        --path . \
                        --format json \
                        --out-file infracost.json \
                        --terraform-plan-path "$PLANFILE" || {
                        echo "âš ï¸  Infracost ì‹¤í–‰ ì‹¤íŒ¨. ê¸°ë³¸ ë¹„ìš© ë°ì´í„° ìƒì„±."
                        echo '{"totalMonthlyCost":"0","currency":"USD","projects":[]}' > infracost.json
                    }
                    
                    infracost breakdown \
                        --path . \
                        --format table \
                        --terraform-plan-path "$PLANFILE" > infracost.txt 2>/dev/null || {
                        echo "ë¹„ìš© ì¶”ì • ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." > infracost.txt
                    }
                fi
            else
                echo "âš ï¸  Infracostê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ. ê¸°ë³¸ ë¹„ìš© ë°ì´í„° ìƒì„±."
                echo '{"totalMonthlyCost":"0","currency":"USD","projects":[]}' > infracost.json
                echo "Infracostê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•„ ë¹„ìš© ì¶”ì •ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." > infracost.txt
            fi
            
            # 3) ì—…ë¡œë“œ ê²½ë¡œ êµ¬ì„±
            BUCKET="${PLAN_BUCKET:-plan-artifacts}"
            PREFIX="atlantis/${BASE_REPO_OWNER}/${BASE_REPO_NAME}/${PULL_NUM}/${PROJECT_NAME:-$(basename "$REPO_REL_DIR" | tr '/' '-')}"
            
            # 4) ë³€ê²½ ìœ ë¬´ ë° ë¹„ìš© ì •ë³´ ê³„ì‚°
            HAS_CHANGES=$(jq '(.resource_changes|length) > 0' tfplan.json)
            MONTHLY_COST=$(jq -r '.totalMonthlyCost // "0"' infracost.json 2>/dev/null || echo "0")
            
            # 5) ë©”íƒ€(manifest) ìƒì„± (ë¹„ìš© ì •ë³´ í¬í•¨)
            jq -n --arg repo "${BASE_REPO_OWNER}/${BASE_REPO_NAME}" \
                  --arg pr "$PULL_NUM" \
                  --arg proj "$PROJECT_NAME" \
                  --arg action "plan" \
                  --arg status "success" \
                  --arg commit "$HEAD_COMMIT" \
                  --arg cost "$MONTHLY_COST" \
                  --argjson has "$HAS_CHANGES" \
                  '{repo:$repo,pr:($pr|tonumber),project:$proj,action:$action,status:$status,commit:$commit,has_changes:$has,monthly_cost:$cost}' \
              > manifest.json
            
            # 6) S3 ì—…ë¡œë“œ (Infracost ê²°ê³¼ í¬í•¨)
            aws s3 cp "$PLANFILE"      "s3://$BUCKET/$PREFIX/tfplan.bin"
            aws s3 cp tfplan.json      "s3://$BUCKET/$PREFIX/tfplan.json"
            aws s3 cp plan.txt         "s3://$BUCKET/$PREFIX/plan.txt"
            aws s3 cp infracost.json   "s3://$BUCKET/$PREFIX/infracost.json"
            aws s3 cp infracost.txt    "s3://$BUCKET/$PREFIX/infracost.txt"
            aws s3 cp manifest.json    "s3://$BUCKET/$PREFIX/manifest.json"
            
            echo "ðŸ“¤ Plan ê²°ê³¼ ë° ë¹„ìš© ì¶”ì •ì´ AI ë¦¬ë·°ë¥¼ ìœ„í•´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "ðŸ’° ì˜ˆìƒ ì›”ê°„ ë¹„ìš©: $MONTHLY_COST USD"
    apply:
      steps:
        - run: |
            set +e
            terraform apply -input=false -no-color "$PLANFILE" | tee apply.txt
            STATUS=$?
            set -e
            BUCKET="${PLAN_BUCKET:-plan-artifacts}"
            PREFIX="atlantis/${BASE_REPO_OWNER}/${BASE_REPO_NAME}/${PULL_NUM}/${PROJECT_NAME:-$(basename "$REPO_REL_DIR" | tr '/' '-')}"
            jq -n --arg repo "${BASE_REPO_OWNER}/${BASE_REPO_NAME}" \
                  --arg pr "$PULL_NUM" \
                  --arg proj "$PROJECT_NAME" \
                  --arg action "apply" \
                  --arg status "$([ $STATUS -eq 0 ] && echo success || echo failure)" \
                  --arg commit "$HEAD_COMMIT" \
                  '{repo:$repo,pr:($pr|tonumber),project:$proj,action:$action,status:$status,commit:$commit}' \
              > manifest.json
            aws s3 cp apply.txt      "s3://$BUCKET/$PREFIX/apply.txt"
            aws s3 cp manifest.json  "s3://$BUCKET/$PREFIX/manifest.json"
            exit $STATUS
